---
title: "Datos DHS"
output: html_document
---

```{r setup, include=F, message=F, warning=F}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(kableExtra)
library(corrplot)
```

# Introducción 

Cuando se trabaja con modelos de simulación en demografía, como puede ser el modelado de las tasas específicas de fecundidad por edad (ASFR), uno de los factores usualmente contemplado es la edad en que las mujeres comienzan a tener riesgo a concebir. En ese sentido, modelar la edad en que una cohorte de mujeres experimenta su primer nacimiento es un factor que puede ser de utilidad para este tipo de simulación.

Buscamos en este caso explorar un modelo que prediga la edad media a la que las mujeres tienen su primer hijo, utilizando como variables explicativas características de las mujeres que pueden influir en la variable de interés.

En este caso se trabaja con datos de las encuestas DHS, realizada en los países de Colombia y Perú, para los periodos 2015 y 2012 respectivamente.

# Fuente de los datos

El Programa de Encuestas Demográficas y de Salud (DHS) es responsable de recopilar y difundir datos precisos y representativos a nivel nacional sobre salud y población en países en desarrollo. El proyecto es financiado por la Agencia de los Estados Unidos para el Desarrollo Internacional (USAID).

La idea detrás es ayudar a los distintos países sobre todo del continente africano a dar asistencia técnica para la implementación de encuestas demográficas y de salud, donde se recolecta información sobre la fecundidad, planificación familiar, salud maternal e infantil y otros temas de salud como la malaria o el VIH que son de interés en gran parte de los países que contempla la encuesta.

# Datos DHS Colombia 2015 y Peru 2012

Variable de interés
- edad_primer_hijo: indica la edad en la que la mujer tuvo su primer hijo

Potenciales variables explicativas
- pais: país de la encuesta
- conoc_metodo: conocimiento de algún tipo de métodos anticonceptivos
- uso_metodo: uso de algún tipo de método anticonceptivo
- urbano_rural: la mujer vive en un área urbana o rural
- ocupacion: la mujer trabaja o no
- riqueza: indice de riqueza estandarizado
- educacion: cantidad de años de educación

Variables adicionales para identificar mujeres y pesos en la muestra
- cluster: id cluster a la que pertenece la obs.
- hogar: id hogar a la que pertenece la obs.
- peso: peso de la mujer en la encuesta
- edad_muj: edad de la mujer encuestada

Como existe un componente temporal ya que se esta trabajando con mujeres de edades distintas (las cohortes mas modernas suelen tener un comportamiento de atrasar el ser madres a edades mas avanzadas), vamos a trabajar solamente con las mujeres que tengan de 18 a 28 años, para minimizar en parte ese efecto temporal. 

En total contamos con 11423 observaciones, de mujeres en ese rango de edad que a su vez tuvieron al menos un hijo.

```{r}
raw_data_co <- read.csv('datos/Colombia/CO_15.csv')
raw_data_pe <- read.csv('datos/Peru/PE_12.csv')

# Juntamos los df
raw_data <- rbind(raw_data_co, raw_data_pe) %>% select(-v102,-v525)

datos <- raw_data %>% 
   mutate(
    v133 = case_match(
      v133,
      97 ~ NA,
      99 ~ NA,
      .default = v133
    ),
    v104 = case_match(
      v104,
      95 ~ v012,
      96 ~ NA,
      97 ~ NA,
      98 ~ NA,
      99 ~ NA,
      .default = v104
    ),
    v613 = case_match(
      v613,
      96 ~ NA,
      98 ~ NA,
      99 ~ NA,
      .default = v613
    ),
    v301 = case_match(
      v301,
      0 ~ "No method", 1 ~ "Folkloric Method", 2 ~ "Traditional Method",
      3 ~ "Modern Method"), 
    v302 = case_match(
      v302,
      0 ~ "No method", 1 ~ "Folkloric Method", 2 ~ "Traditional Method",
      3 ~ "Modern Method"),
    v025 = case_match(
      v025,
      1 ~ "Urban", 2 ~ "Rural"),
    v717 = case_match(
      v717,
      0 ~ "Not working",
      98 ~ NA,
      99 ~ NA, 
      .default = "Working"
    )
  ) %>%
  rename(
    edad_primer_hijo = v212,
    pais = v000,
    cluster = v001,
    hogar = v002,
    año= v007,
    peso = v005,
    conoc_metodo = v301,
    uso_metodo = v302,
    urbano_rural = v025,
    años_residencia = v104,
    ocupacion = v717,
    riqueza = v191,
    educacion = v133,
    ideal_hijos = v613,
    edad_muj = v012
  ) %>%
  filter(edad_muj %in% 18:28, !is.na(edad_primer_hijo)) %>% na.omit()
```


## Descripción de los datos

```{r, echo=FALSE}
variables <- c("edad_primer_hijo", "pais", "conoc_metodo", "uso_metodo",
               "urbano_rural", "ocupacion", "riqueza", "educacion",
               "cluster", "hogar", "peso", "edad_muj")

descripcion <- c("edad en la que la mujer tuvo su primer hijo", "país de la encuesta",
                 "conocimiento de algún tipo de métodos anticonceptivos", "uso de algún tipo de método anticonceptivo",
                 "la mujer vive en un área urbana o rural", "la mujer trabaja o no", "indice de riqueza estandarizado",
                 "cantidad de años de educación", "id cluster a la que pertenece la observación",
                 "id hogar a la que pertenece la observación", "peso de la mujer en la encuesta",
                 "edad de la mujer encuestada")

tipo <- c("Numérica", "Categórica", "Categórica", "Categórica",
          "Categórica", "Categórica", "Numérica", "Numérica",
          "Numérica", "Numérica", "Numérica", "Numérica")

posibles <- c("Números enteros (11 - 28)", "Colombia, Perú",
              "Folkloric Method, Modern Method, Traditional Method, No method",
              "Folkloric Method, Modern Method, Traditional Method, No method",
              "Urban, Rural", "Not working, Working", "Números enteros (-300727 - 206151)",
              "Números enteros <br>(0 - 17)",
              "Números enteros <br>(1 - 5000)", "Números enteros <br>(1 - 9093)",
              "Números enteros (3713 - 37500290)", "Números enteros (18 - 28)")

desc_data <- cbind("Variables" = variables, "Descripción" = descripcion,
                   "Tipo de variable" = tipo, "Posibles valores" = posibles)

desc_data %>%
  kable("html", escape = FALSE, col.names = c("Variables", "Descripción", "Tipo de variable", "Posibles valores")) %>%
  kable_styling(full_width = F, position = "center") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, color = "grey") %>%
  row_spec(0, background = "lightblue", bold = TRUE) %>%
  column_spec(1:4, width = "10em")
```


## Análisis Exploratorio
### Análisis de la Variable a Explicar
```{r}
ggplot(datos, aes(x = edad_primer_hijo)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  labs(title = "Distribución de la Edad del Primer Hijo",
       x = "Edad del Primer Hijo",
       y = "Frecuencia") +
  theme_minimal()
```

### Análisis Variables Categóricas vs Edad Primer Hijo

```{r}
ggplot(datos, aes(x = factor(educacion), y = edad_primer_hijo)) +
  geom_boxplot(fill = "lightgreen", color = "darkgreen") +
  labs(title = "Edad del Primer Hijo por Nivel Educativo",
       x = "Nivel Educativo",
       y = "Edad del Primer Hijo") +
  theme_minimal()

ggplot(datos, aes(x = urbano_rural, y = edad_primer_hijo)) +
  geom_boxplot(fill = "lightcoral", color = "darkred") +
  labs(title = "Edad del Primer Hijo por Área (Urbana/Rural)",
       x = "Área (Urbana/Rural)",
       y = "Edad del Primer Hijo") +
  theme_minimal()
ggplot(datos, aes(x = pais, y = edad_primer_hijo)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(title = "Edad del Primer Hijo por País (Colombia/Perú)",
       x = "País",
       y = "Edad del Primer Hijo") +
  theme_minimal()
ggplot(datos, aes(x = ocupacion, y = edad_primer_hijo)) +
  geom_boxplot(fill = "orange", color = "red") +
  labs(title = "Edad del Primer Hijo por Ocupación de la Mujer",
       x = "Ocupación",
       y = "Edad del Primer Hijo") +
  theme_minimal()
ggplot(datos, aes(x = conoc_metodo, y = edad_primer_hijo)) +
  geom_boxplot(fill = "darkmagenta", color = "pink") +
  labs(title = "Edad del Primer Hijo por Conocimiento de Métodos Anticonceptivos",
       x = "Conocimiento de Métodos Anticonceptivos",
       y = "Edad del Primer Hijo") +
  theme_minimal()
ggplot(datos, aes(x = uso_metodo, y = edad_primer_hijo)) +
  geom_boxplot(fill = "brown4", color = "brown1") +
  labs(title = "Edad del Primer Hijo por Uso de Métodos Anticonceptivos",
       x = "Uso de Métodos Anticonceptivos",
       y = "Edad del Primer Hijo") +
  theme_minimal()
```

### Análisis Variables Numéricas vs Edad Primer Hijo

```{r}
glimpse(datos)
summary(datos)

num_data <- datos %>% select_if(is.numeric)
correlacion<-round(cor(num_data), 1)
corrplot(correlacion, method="number", type="upper")

# library(GGally)
# ggpairs(num_data, lower = list(continuous = "smooth"),
#         diag = list(continuous = "barDiag"), axisLabels = "none")

ggplot(datos, aes(x = riqueza, y = edad_primer_hijo)) +
  geom_point() + geom_smooth() +
  labs(title = "Edad del Primer Hijo por Índice de Riqueza Estandarizado",
       x = "Índice de Riqueza Estandarizado",
       y = "Edad del Primer Hijo") +
  theme_minimal()
ggplot(datos, aes(x = riqueza, y = edad_primer_hijo)) +
  geom_point() + geom_smooth() +
  labs(title = "Edad del Primer Hijo por Índice de Riqueza Estandarizado",
       x = "Índice de Riqueza Estandarizado",
       y = "Edad del Primer Hijo") +
  theme_minimal()

```


