---
title: "Modelado de Variables Demográficas Mediante Algoritmos de Aprendizaje Supervisado"
format: pdf
lang: es
---

```{r setup, include=F, message=F, warning=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(kableExtra)
library(tidymodels)
library(vip)
library(DALEX)
library(DALEXtra)
```

\vspace{-2em}

# Introducción 

Cuando se trabaja con modelos de micro-simulación en demografía, como el modelado de las tasas específicas de fecundidad por edad (ASFR), uno de los factores usualmente considerados es la edad en que las mujeres comienzan a estar en riesgo de concebir. En este contexto, modelar la edad en que una cohorte de mujeres experimenta su primer nacimiento o inicia su vida sexual puede ser de gran utilidad en este tipo de simulaciones.

En este trabajo se propone el uso de modelos de aprendizaje supervisado para evaluar su desempeño en dos objetivos: por un lado, predecir la edad al primer hijo de las mujeres, y por otro, clasificar si una mujer comienza su vida sexual antes o después de una cierta edad. En ambos casos, se emplearán variables socioeconómicas y comportamentales de las mujeres como predictores. Se priorizará el uso de modelos basados en árboles de decisión, como Bagging, Random Forest y XGBoost.

Los datos utilizados para este propósito provienen de las encuestas DHS, realizadas principalmente en países en vías de desarrollo. En este caso particular, se analizarán las encuestas de las rondas VI y VII, correspondientes a distintos países y realizadas entre los años 2010 y 2020.

# Análisis exploratorio

## Fuente de los datos

Como se mencionó en la introducción, los datos provienen de las encuestas DHS[^1], el Programa de Encuestas Demográficas y de Salud (DHS) es responsable de recopilar y difundir datos precisos y representativos a nivel nacional sobre salud y población en países en desarrollo. 

La idea detrás es ayudar a los distintos países sobre todo del continente africano a dar asistencia técnica para la implementación de encuestas demográficas y de salud, donde se recolecta información sobre la fecundidad, planificación familiar, salud maternal e infantil y otros temas de salud como la malaria o el VIH que son de interés en gran parte de los países que contempla la encuesta.

[^1]: https://dhsprogram.com/data/available-datasets.cfm.

## Selección y descripción de los datos

Como primer paso, debido a la magnitud de la encuesta, que abarca un gran número de países y años, se optó por seleccionar un grupo de países representativos de distintas regiones. El objetivo fue capturar la heterogeneidad en las variables de interés desde diversos contextos económicos y culturales. Asimismo, se procuró que las encuestas seleccionadas correspondieran a un período de tiempo similar (en este caso, la década de 2010 a 2020) y que las variables, tanto de interés como explicativas, estuvieran disponibles en todas las encuestas incluidas. Como resultado de este proceso, se eligieron los siguientes países:

- América Latina y el Caribe: Perú, Haití, Guatemala y República Dominicana.
- Europa del este: Albania y Armenia.
- Norte y Sur de África: Etiopía, Ghana, Sudáfrica y Angola.

En este caso, se dispone de un total de aproximadamente 150,000 observaciones correspondientes a mujeres de entre 15 y 64 años. Estas observaciones incluyen variables relacionadas con aspectos económicos, sociales y de salud reproductiva. Una complicación presente en los datos es que las disponibilidad de las distintas variables pueden variar de un país al otro y el proceso de descarga si se seleccionan demasiadas variables puede ser muy lento. Por esta razón se realizó un filtrado previo de las variables a utilizar. Como resultado, se trabaja principalmente con 17 variables que están disponibles para todos los países seleccionados y que, a priori, se consideran las más relevantes para el análisis. Algunas de estas variables no se emplean como predictores, pero resultan útiles en otros aspectos, como el peso muestral de las mujeres en la encuesta, que puede ser incorporado en el modelo.

```{r}
datos_dhs <- read.csv('datos/dhs_6_7.csv') %>%
mutate(v000 = as.factor(case_when(v000 == 'AL7' ~ 'Albania',
v000 == 'AM7' ~ 'Armenia',v000 == 'AO7' ~ 'Angola',
v000 == 'ET7' ~ 'Etiopia',v000 == 'GH6' ~ 'Ghana',
v000 == 'GU6' ~ 'Guatemala', v000 == 'HT7' ~ 'Haiti',
v000 == 'PE6' ~ 'Perú', v000 == 'DR6' ~ 'República Dominicana', v000 == 'ZA7' ~ 'Sudáfrica')),v005=as.numeric(v005)/1e6, v007=as.numeric(v007),v012=as.numeric(v012),v102=as.factor(v102),v119 = as.factor(case_when(v119 %in% c(7,9) ~ NA, T~v119)),v121 = as.factor(case_when(v121 %in% c(7,9) ~ NA, T~v121)),v133=as.numeric(case_when(v133 %in% 97:99~ NA,T~v133)),v136=as.numeric(v136),v157=as.factor(case_when(v157 == 9 ~ NA,v157 %in% c(1,2) ~ 1,v157 == 3 ~ 2, T~v157)),v191=as.numeric(v191)/1e5,v212=as.numeric(v212),v301=as.factor(v301),v525=as.numeric(case_when(v525 %in% 96:99 ~ NA, T~v525)),v714=as.factor(case_when(v714 == 9 ~NA,T~v714)),v836=as.numeric(case_when(v836 %in% 96:99 ~ NA, T~v836)))

cod_variables <- names(datos_dhs)

name_variables <-c('pais','ponderador','anio','edad','urbano','electricidad','tv','anio_educ','tot_fam','leer','ind_riqueza','edad_phijo','con_antic','edad_psexo','trabajo','n_parejas')

desc_variables <- c(
  'País donde se realizó la encuesta',
  'Peso de la mujer en la encuesta, número entero de 8 dígitos, donde 6 dígitos corresponden a decimales',
  'Año en que se realizó la encuesta',
  'Edad de la mujer encuestada',
  'Indica si la mujer es de área urbana o rural',
  'Indica si el hogar tiene acceso a electricidad',
  'El hogar dispone de una televisión',
  'Total años de educación de la mujer, se calcula a partir del nivel máximo de educación alcanzado, es un valor comparable entre países.',
  'Total de personas que viven en el hogar',
  'Frecuencia con que la mujer lee un periódico, revista o libro',
  'Indicador de riqueza del hogar estandarizado, se calcula a partir de distintas medidas como materiales de construcción de la casa y servicios disponibles, su calculo puede variar entre paises.',
  'Edad de la mujer al primer hijo',
  'Conocimiento de algún método anticonceptivo, donde se distingue entre modernos (ej: Condon, pastillas, parches, etc.), tradicionales (ej: Coito interrumpido, calendario, etc.) y folklóricos (ej: Amuletos, rituales, etc.)',
  'Edad de la mujer al primer acto sexual',
  'Indica si la mujer actualmente trabaja',
  'Cantidad de parejas sexuales que ha tenido la mujer'
)

tipo_variables <- c(
  'Categórica',
  'Numérica',
  'Numérica Entera',
  'Numérica Entera',
  'Categórica',
  'Categórica',
  'Categórica',
  'Numérica Entera',
  'Numérica Entera',
  'Categórica',
  'Numérica',
  'Numérica Entera',
  'Categórica',
  'Numérica Entera',
  'Categórica',
  'Numérica Entera'
)

rec_variables <- c('10 paises',' ',paste0(min(datos_dhs$v007),'-',max(datos_dhs$v007)),paste0(min(datos_dhs$v012),'-',max(datos_dhs$v012)),'1:Urbano, 2:Rural','0:No, 1:Si','0:No, 1:Si',paste0(min(datos_dhs$v133,na.rm = T),'-',max(datos_dhs$v133,na.rm = T)),paste0(min(datos_dhs$v136),'-',max(datos_dhs$v136)),'0:Nada, 1:Ocasional, 2:Todos los días',paste0(min(datos_dhs$v191,na.rm = T),'-',max(datos_dhs$v191,na.rm = T)),paste0(min(datos_dhs$v212,na.rm = T),'-',max(datos_dhs$v212,na.rm = T)),'0: Ninguno, 1:Folklórico, 2:Tradicional, 3:Moderno',paste0(min(datos_dhs$v525,na.rm = T),'-',max(datos_dhs$v525,na.rm = T)),'0: No, 1: Si',paste0(min(datos_dhs$v836,na.rm = T),'-',max(datos_dhs$v836,na.rm = T)))
                   
                   
tabla_variables <- data.frame(cod_variables, name_variables,desc_variables,tipo_variables,rec_variables) 

names(datos_dhs) <- name_variables 
```

```{r}
kable(tabla_variables, caption = 'Descripción de las variables disponibles en el trabajo', col.names = c('Codigo DHS','Nombre','Descripción','Tipo','Recorrido'), align = 'ccllc', booktabs = TRUE) %>% 
  kable_styling(latex_options = "striped", font_size = 7, position = "center") %>% column_spec(3, width = '25em') %>%
  column_spec(5, width = '10em') %>% column_spec(c(1,2), width = '5em')
```

Antes de realizar el análisis exploratorio, se procede a limpiar los datos. Tomándose la precaución en cada variable de considerar las codificaciones de no respuesta y dato faltante, como el valor 99, que puede afectar la interpretación sobre todo en variables numéricas.

En cuanto a las variables de interés, como la edad de la mujer al primer hijo, se filtran las observaciones con valores extremadamente atípicos o que no tienen sentido desde el punto de vista biológico, como un valor de 3 años. En este caso, se consideran únicamente las mujeres que tuvieron su primer hijo a partir de los 11 años, límite establecido con base en criterios biológicos.

Respecto a la otra variable de interés, la edad a la primera relación sexual, se decide filtrar a las mujeres que reportaron valores menores a 10 años, con el fin de evitar casos extremadamente atípicos o errores en el registro de datos.

```{r}
datos_phijo <- datos_dhs %>% filter(edad_phijo >= 11) %>% filter(!is.na(edad_phijo),!is.na(tv),!is.na(leer),!is.na(n_parejas),!is.na(trabajo))

datos_psexo <- datos_dhs %>% na.omit() %>% filter(edad_psexo >= 10) %>% mutate(psexo_18 = as.factor(case_when(edad_psexo < 18 ~ 0, T~1)))
```

## Edad al primer hijo

La edad en que las mujeres comienzan a tener hijos está influenciada por una serie de factores en los que se encuentran comportamientos sociales como también por aspectos económicos y culturales. En la bibliografía suelen mencionarse algunos factores que están fuertemente vinculados a los procesos de fecundidad, como la mayor participación en el mercado laboral, el acceso a la educación de las mujeres, la planificación familiar y el uso de métodos anticonceptivos.

En la @fig-phijo_xpais se puede observar como, dependiendo de que país sea la mujer encuestada, varía la edad que tenían al momento en que nació su primer hijo, algo esperable viniendo de paises con contextos muy distintos. En países como Angola, Etiopía, Guatemala o Dominicana, hay una gran parte de las mujeres encuestadas que tiene su primer hijo con veinte años o menos, mientras que en países del Este de Europa algo más desarrollados como Armenia o Albania, la edad al primer hijo tiende a ser mayor con una media por encima de los 20 años, patrón que usualmente se observa mientras más desarrollo más se atrasan todos los procesos relacionados con la fecundidad. Más allá de las diferencias, existe una gran concentración de mujeres que tienen su primer hijo entre los 18 y 23 años en todos los países.

```{r phijo_xpais}
#| label: fig-phijo_xpais
#| fig-cap: "Gráfico violín, distribución de la edad al primer hijo por país, donde el punto indica la edad media."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

datos_phijo %>% 
mutate(pais = forcats::fct_reorder(pais, edad_phijo, .fun = mean))%>%
  ggplot(aes(x=edad_phijo,y=pais,fill=pais,weight=ponderador)) + geom_violin() +
  stat_summary(fun = "mean",
               geom = "point",
               size=4,
               color = "lightgrey") + theme_minimal() + labs(x = 'Edad al primer hijo', y = 'País') + theme(legend.position = 'none') + scale_fill_viridis_d()
```

Uno de los factores más importantes en el proceso del desplazamiento de la fecundidad a edades más avanzadas es el logro educativo de las mujeres. Esto es algo que en los datos utilizados en este trabajo debería poder ser captado. En la @fig-edu_att se observa la distribución de la edad al primer hijo donde cada línea corresponde a la cantidad de años de educación que tuvo la madre. En este caso, se puede observar claramente un corrimiento hacia la derecha de las modas de la distribución a medida que la mujer tiene más años de educación. Esto indica que mientras más estudios tienen las mujeres, más aplazan el momento de tener su primer hijo. Con lo cual en un principio esta variable debería ser útil para predecir la variable de interés.

```{r edu_att}
#| label: fig-edu_att
#| fig-cap: "Gráfico Líneas, distribución de la edad al primer hijo por Años de Educación de la Madre."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

datos_phijo %>% filter(anio_educ < 22) %>%
ggplot(aes(x = edad_phijo, color = anio_educ, group=anio_educ, weight = ponderador)) + geom_density(linewidth=0.8) +
  labs(x = "Edad al Primer Hijo",
       y = "Frecuencia") +
  theme_minimal() + scale_color_viridis_c(name = "Años de Educación")
```

Este patrón es repetido por todos los países, aunque su efecto es más marcado en algunos paises, se observa la @fig-edu_att_xpais donde se tiene la distribución de la edad al primer hijo por país y si la madre presenta mas de 15 años de educación. En todos los países, las mujeres con más años de educación tienden a tener su primer hijo a una edad más avanzada, aunque en países como Albania, este efecto parece bastante menos notorio.

```{r edu_att_xpais}
#| label: fig-edu_att_xpais
#| fig-cap: "Gráfico Caja, distribución de la edad al primer hijo por país y si la mujer tiene más de 15 años de educación."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

datos_phijo %>% mutate(anio_edu_15=as.factor(ifelse(anio_educ>=15,1,0))) %>%
  ggplot(aes(x = pais, y=	edad_phijo, fill=anio_edu_15, weight = ponderador)) +
  geom_boxplot(color = "grey") + theme_minimal()+ scale_fill_viridis_d(name='Años de educación', labels = c('Menor a 15 años', 'Mayor o igual a 15 años')) + labs(x = 'País', y = 'Edad al Primer Hijo') + theme(legend.position = 'top',axis.text.x = element_text(angle = 45, hjust = 1))
```

Otro factor que posiblemente afecte es el nivel de riqueza y la zona del hogar de pertenencia de la mujer, en la @fig-riqueza, se observa que existe un efecto de atrasamiento en la edad al primer hijo a medida que el índice de riqueza aumenta, aunque el efecto no es tan marcado y presenta mayor dispersión para mujeres con mayores niveles de la variable, dónde el efecto parece no estar influenciado por si la zona es urbana o rural siendo muy similar en distribución. Es destacable que en este caso no se está midiendo la riqueza al momento de tener el hijo, por lo que el contexto de la mujer puede haber cambiado en el proceso aunque sigue pareciendo un indicador posiblemente relevante en la predicción. 

```{r riqueza}
#| label: fig-riqueza
#| fig-cap: "Gráfico Caja, distribución de la edad al primer hijo por país y si la mujer tiene más de 15 años de educación."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

datos_phijo %>% mutate(ind_riqueza=as.factor(cut(ind_riqueza,breaks = quantile(datos_phijo$ind_riqueza, probs = seq(0, 1, 0.2)),include.lowest =T))) %>%
ggplot(aes(y =edad_phijo, x=	ind_riqueza,weight = ponderador,fill=urbano)) +
  geom_boxplot(color = "grey") +
  labs(x = "Quintiles Indice de Riqueza",
       y = "Edad al Primer Hijo") +
  theme_minimal() + scale_fill_viridis_d(name="Zona", labels = c("Rural", "Urbano")) 
```

Por otro lado variables como el comportamiento o la educación sexual de la mujer también pueden influir en la edad al primer hijo. En la @fig-comp_sexual se observa la distribución de la edad al primer hijo diferenciando por la cantidad de parejas sexuales que han tenido las mujeres y si la misma conoce algún método anticonceptivo, tanto tradicional como moderno. En este caso, se observa que las mujeres que han tenido más parejas sexuales tienden a tener su primer hijo a una edad más temprana, aunque el efecto no es tan marcado. Por otro lado, las mujeres que conocen algún método anticonceptivo tanto tradicional como moderno presentan una edad al primer hijo más avanzada, algo esperable para cualquiera de las cantidades de parejas que hayan tenido.

```{r comp_sexual}
#| label: fig-comp_sexual
#| fig-cap: "Gráfico Caja, distribución de la edad al primer hijo por Años de Educación de la Madre y por comienzo de relaciones sexuales."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

datos_phijo %>% mutate(n_parejas=as.factor(case_when(n_parejas == 1 ~ '1', n_parejas == 2 ~ '2', n_parejas == 3 ~ '3', 
n_parejas >= 4 ~ '4 o más')),con_antic=as.factor(ifelse(con_antic %in% c(0,1), 0, con_antic))) %>%
ggplot(aes(y = edad_phijo, x= n_parejas,weight = ponderador,fill=con_antic)) +
  geom_boxplot(color = "grey") +
  labs(x = "Cantidad de parejas sexuales",
       y = "Edad al Primer Hijo") +
  theme_minimal() + scale_fill_viridis_d(name="Conocimiento de Métodos", labels = c("No", "Tradicional", "Moderno"))
```

# Modelado de la edad al primer hijo

Una vez visualizados los datos y posibles relaciones en las variables se procede a armar los modelos. 

Para incorporar información sobre el contexto social y económico se toman en cuenta estas 5 variables, algunas de ellas hemos visualizado su efecto, siendo este relevante:

- País de procedencia de la mujer.
- Indice de riqueza del hogar.
- Si el hogar dispone de televisión.
- Si la mujer se encuentra en una área urbana o rural.
- Si la mujer trabaja en la actualidad.

Por lado del nivel educativo de la mujer se toman en cuenta las siguientes variables:

- Años de educación de la mujer.
- Si la mujer lee periódicos, revistas o libros.

Por último, se consideran las siguientes variables relacionadas con el comportamiento sexual de la mujer:

- Cantidad de parejas sexuales que ha tenido la mujer.
- Si la mujer conoce algún método anticonceptivo.

En esta primera aproximación al problema se opta por solamente tomar las observaciones que dispongan de todos los datos necesarios para el modelo, no realizándose imputaciones de datos faltantes o análisis de la no respuesta a la encuesta. 

En total se entrena al modelo con 80359 observaciones de mujeres donde se utilizara un 85% de los datos para entrenar y el 15% restante para evaluar el modelo.

```{r}
datos_split <- initial_split(datos_phijo, 
                              strata = pais,
                              prop = 0.85) 

datos_train <- training(datos_split)
datos_test <- testing(datos_split)

datos_recipe <- recipe(edad_phijo ~ pais  + tv + anio_educ + leer + ind_riqueza + con_antic + n_parejas + trabajo , data = datos_train)
```

En este caso se trabaja integramente con 'tidymodels' framework que permite realizar la evaluación de los modelos de manera sencilla. Se opta por evaluar la eficiencia de modelos basados en árboles: Bagging, Random Forest y CatBoost, donde para cada uno se realiza su correspondiente tuneo de hiperparámetros.

## Bagging

### Búsqueda de Hiperparámetros 

Para evaluar la eficiencia de los modelos de bagging, se realiza mediante la técnica de validación cruzada la búsqueda de hiperparámetros óptimos. En este caso se utiliza 'k-folds cross validation' con 10 folds, donde se busca como hiperparámetros el número mínimo de observaciones por nodo *(min_n)* y la cantidad de árboles a utilizar *(trees)*. Como la cantidad de observaciones es muy grande se opta por armar una grilla con valores de 50 a 5000 para el número mínimo de observaciones, para el número de árboles que no es tan importante como el anterior se opta por valores de 10 a 1000 pero más distanciados. Como engine en este caso se utiliza 'ranger'.

```{r}
tibble(min_n = c(50,100,150,200,250,300,350,400,450,500,
                                    1000,1500,2000,2500,5000),
       trees = c(10,50,100,250,500,1000,"","","","","","","","","")) %>% t() %>% kable(caption = 'Grilla de hiperparámetros para modelos de Bagging',  booktabs = TRUE) %>% 
  kable_styling(latex_options = "striped", font_size = 8, position = "center")
```

```{r}
bagging_spec <- rand_forest(mtry =.cols(), min_n=tune(),  trees=tune()) %>%
  set_engine('ranger', num.threads=6) %>%
  set_mode('regression')

bagging_workflow <- workflow() %>%
  add_model(bagging_spec) %>%
  add_recipe(datos_recipe)
```

```{r, eval=F}
# Tuneo de hiperparametros: num.threads = 64 ->  min aprox.
bagging_grid <- expand.grid(min_n=c(50,100,150,200,250,300,350,400,450,500,
                                    1000,1500,2000,2500,5000),
                            trees=c(10,50,100,250,500,1000))

bagging_cv <- vfold_cv(datos_train, v = 10)

bagging_tune <- tune_grid(bagging_workflow, resamples = bagging_cv, grid = bagging_grid)
```

```{r}
load('datos/bagging_tune.RData')

bagging_metrics <- bagging_tune %>% collect_metrics()
```

```{r bagg_tune}
#| label: fig-bagg_tune
#| fig-cap: "Gráfico de líneas, métrica RMSE y RSQ en función del número mínimo de observaciones por nodo, donde cada línea corresponde a la cantidad de árboles."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

autoplot(bagging_tune) + theme_minimal() + scale_color_viridis_d(name='Cantidad de árboles') + labs(x = "Número mínimo de observaciones por nodo")
```

```{r}
baggin_best <- bagging_tune %>% select_best(metric='rmse')

bagging_fit <- bagging_workflow %>% update_model(
  rand_forest(mtry =.cols(), min_n=tune(),  trees=tune()) %>%
  set_engine('ranger',importance='permutation',num.threads=6) %>% set_mode('regression')
  ) %>%
  finalize_workflow(baggin_best) %>% fit(data = datos_train)
```

### Evaluación del modelo

```{r}
bagging_train <- bagging_fit %>% augment(new_data = datos_train) %>% mutate(residuals = .pred - edad_phijo)
```

Una de las primeras cosas que salen a la vista al evaluar la performance del modelo es que el mismo presenta un rango de predicción con los datos entrenados desde 17 a 30 años, no contemplando los casos no tan comunes de mujeres que tienen su primer hijo a edades mayores a 30 años, a su vez es extraño que el mismo no presente valores menores a 17 años siendo no tan fuera de lo usual observaciones en los datos con 16 o 15 años.

Observando el análisis descriptivo puede ser que la causa sea que ninguna de las covariables consideradas permita captar y distinguir este tipo de casos de mujeres con hijos en altas edades. También se probó la transformación de la variable, tanto utilizando el logaritmo como la raíz cuadrada, pero sin obtener resultados satisfactorios, obteniéndose un rango de edades similar predicho.

En la @fig-bagging_fit_density se puede visualizar la distribución de los valores predichos con los datos de entrenamiento donde se observa lo que se mencionó, el rango se encuentra acotado, la distribución presenta una moda en los 19 años, lo que es bastante coeherente con lo observado en los datos.

```{r bagging_fit_density}
#| label: fig-bagging_fit_density
#| fig-cap: "Gráfico distribución, valores predichos por el modelo de Bagging con los datos de entrenamiento."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

bagging_train %>% ggplot(aes(x=.pred)) + geom_density(fill='darkviolet') + theme_minimal() + labs(x = 'Predicción', y = 'Densidad') + scale_x_continuous(breaks=seq(0,30,1))
```

En la @fig-bagging_res se observa la relación entre las predicciones del modelo Bagging y los residuos de dichas predicciones, junto con una curva ajustada mediante el método de suavizado LOESS. En general, los residuos parecen estar distribuidos de manera homogénea a lo largo del rango de predicciones, sin una tendencia clara, aunque en su mayoría se presentan de forma aleatoria, se nota que el modelo aún muestra una dispersión considerable en alguna zona. Esto indica que, aunque el desempeño general sea bueno, hay casos específicos donde el modelo podría estar cometiendo errores más grandes en sus predicciones.

```{r bagging_res}
#| label: fig-bagging_res
#| fig-cap: "Gráfico de puntos, predicción vs residuos del modelo de Bagging."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

bagging_train  %>% ggplot(aes(x = .pred, y = residuals)) +
  geom_point(alpha=0.5)  + geom_smooth(method = 'loess', se = F, color = 'red') +
  labs(x = "Predicción", y = "Residuos") +
  theme_minimal() 
```

### Interpretación e importancia de las variables

En esta sección se presentarán gráficos que ayudarán a la visualización de la importancia de las variables, tanto para ver a nivel general cuales son las que tienen mayor importancia en este modelo de Bagging, como además se buscará interpretar algunas de estas variables, mediante gráficos de dependencia parcial (PDP) para apreciar el tipo de relación entre la respuesta y la variable explicativa, buscando ver si es lineal, mónotona o más compleja.

En la @fig-bagging_vip vemos un gráfico de barras que nos muestra a las variables explicativas ordenadas de mayor a menor importancia dentro del modelo de Bagging. Vemos entonces que la variable de mayor importancia en el modelo es la que indica los años de educación que alcanzó la mujer, seguida por el país de presedencia y el indice de riqueza de la mujer. Llama la atención, y cabe mencionar que en este caso la variable de menor importancia sería la que hace referencia a si la mujer trabaja o no hoy en día.

```{r bagging_vip}
#| label: fig-bagging_vip
#| fig-cap: "Gráfico barras, importancia de las variables en el modelo de Bagging."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

vip(bagging_fit) + theme_minimal() + labs(y='Importancia', x='Variables')
```

```{r}
explainer_bagging <-
  explain_tidymodels(
    model= bagging_fit,
    data = datos_train,
    y = datos_train$edad_phijo,
    label = "bagging",
    verbose = FALSE
  )
```

```{r}
pdp_educ <- model_profile(explainer_bagging, N = 1000, variables = "anio_educ")

pdp_riqueza <- model_profile(explainer_bagging, N = 1000, variables = "ind_riqueza")

pdp_pais <- model_profile(explainer_bagging, N = 1000, variables = "pais")
```

Ahora intentaremos describir la relación entre la respuesta y algunos de los predictores de manera individual, para un mejor entendimiento, mediante gráficos PDP que permiten ver el efecto marginal de las variables explicativas en el valor predicho del modelo. En la @fig-pdp_educ, observamos el efecto de los años de educación. Se puede ver que, para valores muy bajos de los años de educación, la edad media de las mujeres está entre los 19 y 20 años, hasta llegar a los 9 años de educación. A partir de ese punto, la edad media empieza a subir de manera muy marcada, alcanzando casi los 24 años para las mujeres con 16 años de educación. Luego vemos cómo sigue subiendo, pero es importante tener en cuenta la cantidad de observaciones. Puede estar ocurriendo que haya años de educación con pocas observaciones, lo que haría difícil afirmar que esto sigue subiendo de manera tan pronunciada. 

```{r pdp_educ}
#| label: fig-pdp_educ
#| fig-cap: "Gráfico PDP, efecto de los años de educación en la edad al primer hijo."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

plot(pdp_educ) + geom_rug() + theme_minimal() + labs(title='',subtitle='',x='Años de Educación', y='Edad Media al Primer Hijo')
```

En la @fig-pdp_riqueza vemos el efecto del índice de riqueza en la edad al primer hijo. En esta figura se nota de forma muy clara que hay pocas observaciones en valores extremos del índice de riqueza, por lo que las edades medias en estos extremos no son tan creíbles. Sin embargo, si nos centramos en valores del índice entre -1 y 2, que es donde se encuentran la mayor cantidad de observaciones, podemos decir que la edad media de las mujeres al tener el primer hijo oscila en torno a los 20 años hasta que se alcanza el 0 en el índice. A partir de ese valor, se da un incremento casi monótono en la edad media, con algunas excepciones en ciertos valores que provocan pequeñas caídas, pero llegando, en valores cercanos a 2 del índice, a edades medias de más de 21 años.

```{r pdp_riqueza}
#| label: fig-pdp_riqueza
#| fig-cap: "Gráfico PDP, efecto del indice de riqueza en la edad al primer hijo."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

plot(pdp_riqueza) + geom_rug() + theme_minimal() + labs(title='',subtitle='',x='Indice de Riqueza', y='Edad Media al Primer Hijo') + xlim(-2,3.5)
```

Por último presentamos el gráfico PDP para el país de nacimiento de las mujeres en la @fig-pdp_pais. En este vemos la edad media al primer hijo en forma de barra debido a que la variable país es categórica. Los países con mayor edad media son Albania y Haití con valores por encima de los 21 años, mientras que los países con valores más chicos son Angola y Dominicana con edad media de la mujer al tener el primer hijo por debajo de los 19 años.

```{r pdp_pais}
#| label: fig-pdp_pais
#| fig-cap: "Gráfico PDP, efecto del país en la edad al primer hijo."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

plot(pdp_pais) + geom_rug() + theme_minimal() + labs(title='',subtitle='',x='País', y='Edad Media al Primer Hijo') + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Random Forest

### Busqueda de Hiperparámetros

Para evaluar la eficiencia de los modelos de Random Forest, se realiza mediante la técnica de validación cruzada la búsqueda de hiperparámetros óptimos, de la misma manera que se hizo en la sección de Bagging. Aquí se vuelve a utilizar 'k-folds cross validation' con 10 folds, donde se busca como hiperparámetros el *(min_n)* y *(trees)*, como antes, pero además se busca el número de predictores que se seleccionarán aleatoriamente en cada división *(mtry)*. En este caso la grilla se arma con los mismos valores para el número mínimo de observaciones y para el número de árboles, y para el número de predictores se usa una grilla que tome valores de 2 a 8 de 2 en 2. Como engine se vuelve a utilizar 'ranger'.

```{r}
rf_spec <- rand_forest(mtry =tune(), min_n=tune(),  trees=tune()) %>%
  set_engine('ranger', num.threads=6) %>%
  set_mode('regression')

rf_workflow <- workflow() %>%
  add_model(rf_spec) %>%
  add_recipe(datos_recipe)
```

```{r, eval=F}
# Tuneo de hiperparametros: num.threads = 64 ->  min aprox.
rf_grid <- expand.grid(mtry = c(2,4,6,8),
  min_n=c(50,100,150,200,250,300,350,400,450,500, 1000,1500,2000,2500,5000), trees=c(10,50,100,250,500,1000))

rf_cv <- vfold_cv(datos_train, v = 10)

rf_tune <- tune_grid(rf_workflow, resamples = rf_cv, grid = rf_grid)
```

```{r}
load('datos/rf_tune.RData')

rf_metrics <- rf_tune %>% collect_metrics()
```


```{r rf_tune}
#| label: fig-rf_tune
#| fig-cap: "Gráfico de líneas, métrica RMSE y RSQ en función del número mínimo de observaciones por nodo, donde cada línea corresponde a la cantidad de árboles."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

autoplot(rf_tune) + theme_minimal() + scale_color_viridis_d(name='Cantidad de árboles') + labs(x = "Número mínimo de observaciones por nodo")
```

```{r}
rf_best <- rf_tune %>% select_best(metric='rmse')

rf_fit <- rf_workflow %>% update_model(
  rand_forest(mtry =tune(), min_n=tune(),  trees=tune()) %>%
  set_engine('ranger',importance='permutation',num.threads=6) %>% set_mode('regression')
  ) %>%
  finalize_workflow(rf_best) %>% fit(data = datos_train)
```

### Evaluación del modelo

```{r}
rf_train <- rf_fit %>% augment(new_data = datos_train) %>% mutate(residuals = .pred - edad_phijo)
```

Al igual que en Bagging lo primero que llama la atención al evaluar la performance del modelo es que el mismo presenta un rango de predicción con los datos entrenados desde 17 a 30 años, lo cual ya discutimos en la sección anterior.

En la @fig-rf_fit_density se puede visualizar la distribución de los valores predichos con los datos de entrenamiento donde se observa lo que se mencionó, el rango se encuentra acotado, la distribución presenta una moda en los 19 años, al igual que sucedían en Bagging, la diferencia en este caso es que los datos están un poco mas dispersos cerca de esa moda.

```{r rf_fit_density}
#| label: fig-rf_fit_density
#| fig-cap: "Gráfico distribución, valores predichos por el modelo de rf con los datos de entrenamiento."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

rf_train %>% ggplot(aes(x=.pred)) + geom_density(fill='darkviolet') + theme_minimal() + labs(x = 'Predicción', y = 'Densidad') + scale_x_continuous(breaks=seq(0,30,1))
```

En la @fig-rf_res observamos la misma relación entre las predicciones del modelo RF y los residuos de dichas predicciones, junto con la curva ajustada mediante LOESS, que observamos usando Bagging.

```{r rf_res}
#| label: fig-rf_res
#| fig-cap: "Gráfico de puntos, predicción vs residuos del modelo de rf."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

rf_train %>% ggplot(aes(x = .pred, y = residuals)) +
  geom_point(alpha=0.5)  + geom_smooth(method = 'loess', se = F, color = 'red') +
  labs(x = "Predicción", y = "Residuos") +
  theme_minimal()
```

### Interpretación e importancia de las variables

En esta sección se presentarán los mismos gráficos que ayudan a la visualización de la importancia de las variables y que sirven para apreciar el tipo de relación entre la respuesta y la variable explicativa usados anteriormente.

En la @fig-rf_vip vemos un gráfico de barras que nos muestra a las variables explicativas ordenadas de mayor a menor importancia dentro del modelo de Random Forest. Vemos entonces que la variable de mayor importancia en el modelo sigue siendo la que indica los años de educación que alcanzó la mujer, y el orden sigue de la misma manera que en Bagging, pero ahora vemos algunas variables con mayor importancia que la que tenían en la otra sección, como por ejemplo el país y el indice de riqueza.

```{r rf_vip}
#| label: fig-rf_vip
#| fig-cap: "Gráfico barras, importancia de las variables en el modelo de rf."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

vip(rf_fit) + theme_minimal() + labs(y='Importancia', x='Variables')
```

```{r}
explainer_rf <-
  explain_tidymodels(
    model= rf_fit,
    data = datos_train,
    y = datos_train$edad_phijo,
    label = "rf",
    verbose = FALSE
  )
```

```{r}
rf_pdp_educ <- model_profile(explainer_rf, N = 1000, variables = "anio_educ")

rf_pdp_riqueza <- model_profile(explainer_rf, N = 1000, variables = "ind_riqueza")

rf_pdp_pais <- model_profile(explainer_rf, N = 1000, variables = "pais")
```

Ahora intentaremos describir la relación entre la respuesta y algunos de los predictores de manera individual, para un mejor entendimiento, mediante gráficos PDP. En la @fig-rf_pdp_educ, observamos el efecto de los años de educación. Se pueden ver resultados muy similares a los de la sección pasada, pero debido al problema ya mencionado de tener pocas observaciones para algunos años de educación, vemos como de los 18 a los 25 años de educación no se mueve casi la edad media de las mujeres al tener su primer hijo, parece estabilizarse en los 24 años. 

```{r rf_pdp_educ}
#| label: fig-rf_pdp_educ
#| fig-cap: "Gráfico PDP, efecto de los años de educación en la edad al primer hijo."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

plot(rf_pdp_educ) + geom_rug() + theme_minimal() + labs(title='',subtitle='',x='Años de Educación', y='Edad Media al Primer Hijo')
```

En la @fig-rf_pdp_riqueza vemos el efecto del índice de riqueza en la edad al primer hijo. En esta figura se nota de forma muy clara que hay pocas observaciones en valores extremos del índice de riqueza, al igual que antes, por lo que las edades medias en estos extremos no son tan creíbles. En los valores entre -1 y 2 se aprecian resultados muy similares a los observados en Bagging, primero oscila un poco en valores cercanos a los 20 años y a partir del 0 empieza a subir la edad media de las mujeres hasta pasar los 21 años para un valor de 2 del indice de riqueza.

```{r rf_pdp_riqueza}
#| label: fig-rf_pdp_riqueza
#| fig-cap: "Gráfico PDP, efecto del indice de riqueza en la edad al primer hijo."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

plot(rf_pdp_riqueza) + geom_rug() + theme_minimal() + labs(title='',subtitle='',x='Indice de Riqueza', y='Edad Media al Primer Hijo') + xlim(-2,3.5)
```

Por último presentamos el gráfico PDP para el país de nacimiento de las mujeres en la @fig-rf_pdp_pais. La única diferencia que vale la pena destacar en comparación con la @fig-pdp_pais es que en Haití la edad media de las mujeres al tener el primer hijo es un poco más baja y en Dominicana sucede lo contrario, ahora sube un poco la edad media.

```{r rf_pdp_pais}
#| label: fig-rf_pdp_pais
#| fig-cap: "Gráfico PDP, efecto del país en la edad al primer hijo."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

plot(rf_pdp_pais) + geom_rug() + theme_minimal() + labs(title='',subtitle='',x='País', y='Edad Media al Primer Hijo') + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Modelado de la edad a la primera relación sexual

```{r}
datos_split_class <- initial_split(datos_psexo, 
                              strata = pais,
                              prop = 0.85)

datos_train_class <- training(datos_split_class)
datos_test_class <- testing(datos_split_class)

datos_recipe_class <- recipe(psexo_18 ~ pais + tv + anio_educ + leer + ind_riqueza + n_parejas + trabajo , data = datos_train_class)
```

## Regresión Logistica

```{r}
glm_spec <- logistic_reg() %>%
  set_engine('glm', family = binomial) %>%
  set_mode('classification')

glm_workflow <- workflow() %>%
  add_model(glm_spec) %>%
  add_recipe(datos_recipe_class)

glm_fit <- glm_workflow %>% fit(data = datos_train_class)
```

```{r}
glm_class_test <- glm_fit %>% augment(new_data = datos_test_class)

glm_class_test %>% conf_mat(truth = psexo_18, estimate = .pred_class) %>% summary()
```

## Random Forest 

### Busqueda de Hiperparámetros

```{r}
rf_spec_class <- rand_forest(mtry =tune(), min_n=tune(),  trees=tune()) %>% 
  set_engine('ranger', num.threads=6) %>%
  set_mode('classification')

rf_workflow_class <- workflow() %>%
  add_model(rf_spec_class) %>%
  add_recipe(datos_recipe_class)
```

```{r, eval=F}
# Tuneo de hiperparametros: num.threads = 64 ->  min aprox.
rf_grid_class <- expand.grid(mtry = c(2,4,6,8),
  min_n=c(50,100,150,200,250,300,350,400,450,500, 1000,1500,2000,2500,5000), trees=c(10,50,100,250,500,1000))

rf_cv_class <- vfold_cv(datos_train_class, v = 10)

rf_tune_class <- tune_grid(rf_workflow_class, resamples = rf_cv_class, grid = rf_grid_class)
```

```{r}
load('datos/rf_tune_clas.RData')

rf_metrics_clas <- rf_tune_clas %>% collect_metrics()
```

```{r rf_tune}
#| label: fig-rf_tune_class
#| fig-cap: "Gráfico de líneas, métrica RMSE y RSQ en función del número mínimo de observaciones por nodo, donde cada línea corresponde a la cantidad de árboles."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

autoplot(rf_tune_clas) + theme_minimal() + scale_color_viridis_d(name='Cantidad de árboles') + labs(x = "Número mínimo de observaciones por nodo")
```
```{r}
rf_best_class <- rf_tune_clas %>% select_best(metric='roc_auc')

rf_fit_class <- rf_workflow_class %>% update_model(
  rand_forest(mtry =tune(), min_n=tune(),  trees=tune()) %>%
  set_engine('ranger',importance='permutation',num.threads=6) %>% set_mode('classification')
  ) %>%
  finalize_workflow(rf_best_class) %>% fit(data = datos_train_class)
```

### Evaluación del modelo

```{r}
rf_test_class <- rf_fit_class %>% augment(new_data = datos_test_class)

rf_test_class %>% conf_mat(truth = psexo_18, estimate = .pred_class) %>% summary()
```

```{r}
roc_log <- glm_class_test %>% roc_curve(truth = psexo_18, .pred_0) %>% mutate(Modelo=as.factor('Regresión Logística'))
roc_rf <- rf_test_class %>% roc_curve(truth = psexo_18, .pred_0)%>% mutate(Modelo=as.factor('Random Forest'))

ggplot(rbind(roc_log,roc_rf), aes(x = 1 - specificity, y = sensitivity, color = Modelo)) +
  geom_path(size = 1.2) +
  geom_abline(linetype = "dashed", color = "gray") +
  labs(x = "1 - Especificidad",
       y = "Sensibilidad") + coord_fixed() +
  theme_minimal()
```

### Interpretación e importancia de las variables

```{r}
vip(rf_fit_class) + theme_minimal() + labs(y='Importancia', x='Variables')
```

```{r}
explainer_rf_class <-
  explain_tidymodels(
    model= rf_fit_class,
    data = datos_train_class,
    y = datos_train_class$psexo_18,
    label = "rf_clas",
    verbose = FALSE
  )
```

```{r}
rf_pdp_educ_class <- model_profile(explainer_rf_class, N = 1000, variables = "anio_educ")
```

```{r}
plot(rf_pdp_educ_class) + geom_rug() + theme_minimal() + labs(title='',subtitle='',x='Años de Educación', y='Prob. relaciones > 18 años')
```

```{r}
rf_pdp_riqueza_class <- model_profile(explainer_rf_class, N = 1000, variables = "ind_riqueza")
```

```{r}
plot(rf_pdp_riqueza_class) + geom_rug() + theme_minimal() + labs(title='',subtitle='',x='Indice de Riqueza', y='Prob. relaciones > 18 años') + xlim(-2,3.5)
```

```{r}
rf_n_parejas_class <- model_profile(explainer_rf_class, N = 1000, variables = "n_parejas")
```

```{r}
plot(rf_n_parejas_class) + geom_rug() + theme_minimal() + xlim(c(1,5)) + labs(title='',subtitle='',x='Cantidad de parejas sexuales', y='Prob. relaciones > 18 años')
```





