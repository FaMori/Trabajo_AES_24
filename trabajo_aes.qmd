---
title: "Modelado de variables demograficas mediante algoritmos de aprendizaje supervisado"
format: pdf
---

```{r setup, include=F, message=F, warning=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(kableExtra)
library(tidymodels)

```


# Introducción 

Cuando se trabaja con modelos de micro-simulación en demografía, como puede ser el modelado de las tasas específicas de fecundidad por edad (ASFR), uno de los factores usualmente contemplado es la edad en que las mujeres comienzan a tener riesgo a concebir. En ese sentido, modelar la edad en que una cohorte de mujeres experimenta su primer nacimiento o cuando comienzan a tener relaciones sexuales es un factor que puede ser de utilidad para este tipo de simulación.

En este caso se explora el uso de un modelo de regresión para predecir la edad al primer hijo de las mujeres y otro de clasificación para predecir si una mujer comienza a tener relaciones sexuales antes o despues de cierta edad. Se utilizaran principalmente modelos basados en arbóles de decisión, como CART, Bagging y Random Forest.

Los datos utilizados pertenecen a las encuestas DHS, realizada principalmente en países en vias de desarrollo, donde se tomaran las encuestas VI y VII, realizadas entre los años 2010-2020, se utilizaran los datos de varios paises de distintas regiones para visualizar el efecto de las variables de interes en precencia de contextos socioculturales y economicos muy distintos.

# Análisis exploratorio

## Fuente de los datos

Como se menciono en la introducción los datos provienen de las encuestas DHS, el Programa de Encuestas Demográficas y de Salud (DHS) es responsable de recopilar y difundir datos precisos y representativos a nivel nacional sobre salud y población en países en desarrollo. El proyecto es financiado por la Agencia de los Estados Unidos para el Desarrollo Internacional (USAID).

La idea detrás es ayudar a los distintos países sobre todo del continente africano a dar asistencia técnica para la implementación de encuestas demográficas y de salud, donde se recolecta información sobre la fecundidad, planificación familiar, salud maternal e infantil y otros temas de salud como la malaria o el VIH que son de interés en gran parte de los países que contempla la encuesta.

## Descripción de los datos

Los datos utilizados en esta ocasión corresponden a 10 paises de distintas regiones del mundo:

- America Latina y el Caribe: Peru, Haiti, Guatemala y República Dominicana.
- Europa del este: Albania y Armenia.
- Norte y Sur de Africa: Etiopia, Ghana, Sudáfrica y Angola.

En este caso se tiene un total de casi 150 mil observaciones que corresponden a mujeres de entre 15 y 64 años, donde se tienen variables de aspectos economicos, sociales y de salud reproductiva. En este caso se trabaja con 17 variables en total que se detallan a continuacion:

```{r}
datos_dhs <- read.csv('datos/dhs_6_7.csv') %>%
mutate(v000 = as.factor(case_when(v000 == 'AL7' ~ 'Albania',
v000 == 'AM7' ~ 'Armenia',v000 == 'AO7' ~ 'Angola',
v000 == 'ET7' ~ 'Etiopia',v000 == 'GH6' ~ 'Ghana',
v000 == 'GU6' ~ 'Guatemala', v000 == 'HT7' ~ 'Haiti',
v000 == 'PE6' ~ 'Perú', v000 == 'DR6' ~ 'República Dominicana', v000 == 'ZA7' ~ 'Sudáfrica')),v005=as.numeric(v005), v007=as.numeric(v007),v012=as.numeric(v012),v102=as.factor(v102),v119 = as.factor(case_when(v119 %in% c(7,9) ~ NA, T~v119)),v121 = as.factor(case_when(v121 %in% c(7,9) ~ NA, T~v121)),v133=as.numeric(case_when(v133 %in% 97:99~ NA,T~v133)),v136=as.numeric(v136),v157=as.factor(case_when(v157 == 9 ~ NA,v157 %in% c(1,2) ~ 1,v157 == 3 ~ 2, T~v157)),v191=as.numeric(v191),v212=as.numeric(v212),v301=as.factor(v301),v525=as.numeric(case_when(v525 %in% 96:99 ~ NA, T~v525)),v714=as.factor(case_when(v714 == 9 ~NA,T~v714)),v836=as.numeric(case_when(v836 %in% 96:99 ~ NA, T~v836)))

cod_variables <- names(datos_dhs)

name_variables <-c('pais','ponderador','anio','edad','urbano','electricidad','tv','anio_educ','tot_fam','leer','ind_riqueza','edad_phijo','con_antic','edad_psexo','trabajo','n_parejas')

desc_variables <- c(
  'País donde se realizó la encuesta',
  'Peso de la mujer en la encuesta, número entero de 8 dígitos, donde 6 dígitos corresponden a decimales',
  'Año en que se realizó la encuesta',
  'Edad de la mujer encuestada',
  'Indica si la mujer es de área urbana o rural',
  'Indica si el hogar tiene acceso a electricidad',
  'El hogar dispone de una televisión',
  'Total años de educación de la mujer, se calcula a partir del nivel máximo de educación alcanzado, es un valor comparable entre países.',
  'Total de personas que viven en el hogar',
  'Frecuencia con que la mujer lee un periódico, revista o libro',
  'Indicador de riqueza del hogar estandarizado, se calcula a partir de distintas medidas como materiales de construcción de la casa y servicios disponibles, su calculo puede variar entre paises.',
  'Edad de la mujer al primer hijo',
  'Conocimiento de algún método anticonceptivo, donde se distingue entre modernos (ej: Condon, pastillas, parches, etc.), tradicionales (ej: Coito interrumpido, calendario, etc.) y folklóricos (ej: Amuletos, rituales, etc.)',
  'Edad de la mujer al primer acto sexual',
  'Indica si la mujer actualmente trabaja',
  'Cantidad de parejas sexuales que ha tenido la mujer'
)

tipo_variables <- c(
  'Categórica',
  'Numérica Entera',
  'Numérica Entera',
  'Numérica Entera',
  'Categórica',
  'Categórica',
  'Categórica',
  'Numérica Entera',
  'Numérica Entera',
  'Categórica',
  'Numérica Entera',
  'Numérica Entera',
  'Categórica',
  'Numérica Entera',
  'Categórica',
  'Numérica Entera'
)

rec_variables <- c('10 paises',' ',paste0(min(datos_dhs$v007),'-',max(datos_dhs$v007)),paste0(min(datos_dhs$v012),'-',max(datos_dhs$v012)),'1:Urbano, 2:Rural','0:No, 1:Si','0:No, 1:Si',paste0(min(datos_dhs$v133,na.rm = T),'-',max(datos_dhs$v133,na.rm = T)),paste0(min(datos_dhs$v136),'-',max(datos_dhs$v136)),'0:Nada, 1:Ocasional, 2:Todos los días',paste0(min(datos_dhs$v191,na.rm = T),'-',max(datos_dhs$v191,na.rm = T)),paste0(min(datos_dhs$v212,na.rm = T),'-',max(datos_dhs$v212,na.rm = T)),'0: Ninguno, 1:Folklórico, 2:Tradicional, 3:Moderno',paste0(min(datos_dhs$v525,na.rm = T),'-',max(datos_dhs$v525,na.rm = T)),'0: No, 1: Si',paste0(min(datos_dhs$v836,na.rm = T),'-',max(datos_dhs$v836,na.rm = T)))
                   
                   
tabla_variables <- data.frame(cod_variables, name_variables,desc_variables,tipo_variables,rec_variables) 

names(datos_dhs) <- name_variables 
```

```{r}
kable(tabla_variables, caption = 'Descripción de las variables disponibles en el trabajo', col.names = c('Codigo DHS','Nombre','Descripción','Tipo','Recorrido'), align = 'ccllc', booktabs = TRUE) %>% 
  kable_styling(latex_options = "striped", font_size = 8, position = "center") %>% column_spec(3, width = '25em') %>%
  column_spec(5, width = '10em') %>% column_spec(c(1,2), width = '5em')
```

Antes de realizar el analisis exploratorio se procede a limpiar los datos, se debe tener la precaución de eliminar todas las codificaciones de no respuesta como 99 para que no afecten a las variables numericas. En cuanto a las variables de interes, como edad de la mujer al primer hijo se procede a filtrar las observaciones demasiado extremas o que no tengan sentido desde el punto de vista biologico como un valor de 3 años, en este caso se toma solamente a las mujeres que tuvieron su primer hijo a partir de los 15 años.
En cuanto a la otra variable de interes edad a la primera relación sexual, se opta por filtrar a las mujeres que indicaron valores menores a 10 años nuevamente para evitar casos muy atipicos o errores en el ingreso del dato.

```{r}
datos_phijo <- datos_dhs %>% na.omit() %>% filter(edad_phijo >= 11) 

datos_psexo <- datos_dhs %>% na.omit() %>% filter(edad_psexo >= 10) %>% mutate(psexo_16 = case_when(edad_psexo < 16 ~ 0, T~1))
```

El primer paso del análisis exploratorio de las variables a utilizar en el modelo será realizar gráficos comparando las dos variables de interés escogidas con las variables explicativas que formarán parte del modelo. De esta manera, se puede obtener una primera observación del efecto que podría tener cada variable con respecto a las variables de interés.
### Variables de interes por pais

```{r, fig.align='center', fig.cap='Grafico violín, distribución de la edad al primer hijo por país', fig.height=6, fig.width=10}
datos_phijo %>% 
mutate(pais = forcats::fct_reorder(pais, edad_phijo, .fun = mean))%>%
  ggplot(aes(x=edad_phijo,y=pais,fill=pais)) + geom_violin() + theme_minimal() + labs(x = 'Edad al primer hijo', y = 'País') + theme(legend.position = 'none') + scale_fill_viridis_d()
```
En este primer gráfico se puede observar como, dependiendo de que país sea la mujer encuestada, varía la edad que tenían al momento en que nació su primer hijo. En países como Angola, Etiopía, Guatemala o Dominicana, la gran mayoría de las mujeres encuestadas tiene su primer hijo con veinte años o menos, mientras que en países como Armenia o Albania, sucede lo contrario. Este gráfico nos da un indicio a considerar inicialmente la variable del país de la mujer en el modelo.


```{r fig.align='center', fig.cap='Grafico Caja, distribución de la edad al primer hijo por Índice de Riqueza y Zona del país', fig.height=6, fig.width=10}
datos_phijo %>%  mutate(edad_phijo = cut(edad_phijo, breaks = seq(10, 49, 3))) %>%
ggplot(aes(x = as.factor(edad_phijo), y=	ind_riqueza,fill=urbano)) +
  geom_boxplot(color = "grey") +
  labs(x = "Edad al Primer Hijo",
       y = "Indicador de Riqueza") +
  theme_minimal() + scale_fill_viridis_d(name = "Zona", labels = c("Urbano", "Rural"))
```
En el gráfico anterior se puede observar como, en zonas urbanas, mientras más tarde una mujer tenga su primer hijo, mayor es su riqueza, hasta que luego de los treinta y siete años arranca a decaer el índice de riqueza nuevamente, pero para estas edades ya se cuenta con menos observaciones. En el caso de zonas rurales, esta relación no parece tan clara y el Índice de Riqueza se mantiene aproximadamente en el mismo nivel para todas las franjas de edades al primer hijo que se formaron.


# Edad al Primer Hijo variables comportamiento sexual

```{r fig.align='center', fig.cap='Grafico Líneas, distribución de la edad al primer hijo por Años de Educación de la Madre', fig.height=6, fig.width=10}
datos_phijo %>% filter(anio_educ < 22) %>%
ggplot(aes(x = edad_phijo, color = anio_educ, group=anio_educ)) + geom_density(linewidth=0.8) +
  labs(x = "Edad al Primer Hijo",
       y = "Frecuencia") +
  theme_minimal() + scale_color_viridis_c(name = "Años de Educación")
```

La anterior visualización corresponde a un gráfico de densidad de la edad al primer hijo donde cada línea corresponde a la cantidad de años de eucación que tuvo la madre. En este caso, se puede observar claramente un corrimiento hacia la derecha de las medias de la distribución a medida que la mujer tiene más años de educación. Esto indica que mientras más estudios tienen las mujeres, más demoran en tener su primer hijo.

```{r fig.align='center', fig.cap='Grafico Caja, distribución de la edad al primer hijo por Años de Educación de la Madre y por comienzo de relaciones sexuales', fig.height=6, fig.width=10}
datos_phijo %>% mutate(psexo_16 = as.factor(case_when(edad_psexo < 16 ~ 0, T~1)))  %>%
  filter(anio_educ < 20) %>%
ggplot(aes(y = edad_phijo, x=	as.factor(anio_educ),fill=psexo_16)) +
  geom_boxplot(color = "grey") +
  labs(x = "Años de educación",
       y = "Edad al Primer Hijo") +
  theme_minimal() + scale_fill_viridis_d(name = "Edad primer act. sexual", labels = c("< 16 años", "> 16 años"))
```

Por último, a la visualización del gráfico anterior, se le agregó una segregación por una variable binaria que indica si la mujer encuestada comenzo a tener relaciones sexuales antes o después de los dieciséis años. Se sigue observando la misma relación de que a mayor años de educación, más demoran las mujeres en tener su primer hijo, pero también se le agrega una diferencia en la edad que las mujeres comienzan a tener relaciones sexuales. Se ve claramente que las mujeres que comienzan luego de los dieciséis años, la distribución indica que generalmente tienen su primer hijo más tarde que las mujeres que comienzan antes.

# Modelado de la edad al primer hijo

```{r}
datos_split <- initial_split(datos_phijo, 
                              strata = pais,
                              prop = 0.85) 

datos_train <- training(datos_split)
datos_test <- testing(datos_split)

datos_recipe <- recipe(edad_phijo ~ pais + urbano + edad_psexo + anio_educ + leer + ind_riqueza + con_antic + n_parejas, data = datos_train) %>%
  step_normalize(all_numeric_predictors())
```


# Bagging

```{r}
bagging_spec <- rand_forest(mtry =.cols(), min_n=tune(),  trees=tune()) %>%
  set_engine('ranger', importance = "permutation", num.threads=6) %>%
  set_mode('regression')

bagging_workflow <- workflow() %>%
  add_model(bagging_spec) %>%
  add_recipe(datos_recipe)
```

```{r, eval=F}
# num.threads = 32 -> 31 min aprox.
bagging_grid <- grid_regular(min_n(range = c(10, 500)),
                       trees(range = c(10, 2000)),levels=5)

bagging_cv <- vfold_cv(datos_train, v = 10)

bagging_tune <- tune_grid(bagging_wf, resamples = bagging_cv, grid = bagging_grid)
```

```{r}
load('datos/bagging_tune.RData')
```

```{r}
bagg_tune %>% select(trees,min_n,.metric,mean) %>%
  filter(.metric == "rmse") %>%
  ggplot(aes(x = min_n, y = mean, color = as.factor(trees), group=as.factor(trees))) +
  geom_line() +
  scale_color_viridis_d(name='Cantidad de arboles') +
  labs(x = "Número mínimo de observaciones por nodo", y = "RMSE", fill = "RMSE") +
  theme_minimal()

bagg_tune %>% select(trees,min_n,.metric,mean) %>%
  filter(.metric == "rsq") %>%
  ggplot(aes(x = min_n, y = mean, color = as.factor(trees), group=as.factor(trees))) +
  geom_line() +
  scale_color_viridis_d(name='Cantidad de arboles') +
  labs(x = "Número mínimo de observaciones por nodo", y = "RSQ", fill = "RMSE") +
  theme_minimal()
```


```{r}
bagging_spec <- rand_forest(mtry =.cols(), min_n=130,  trees=1000) %>%
  set_engine('ranger', importance = "permutation", num.threads=6) %>%
  set_mode('regression')

bagging_workflow <- workflow() %>%
  add_model(bagging_spec) %>%
  add_recipe(datos_recipe)

bagging_fit <- fit(bagging_workflow, data = datos_train)
```

## Importancia de las variables

```{r}
library(vip)
vip(bagging_fit) + theme_minimal()
```

```{r}
augment(bagging_fit, new_data = datos_test) %>%
  ggplot(aes(x = .pred, y = edad_phijo)) +
  geom_point() +
  geom_abline(color='red') +
  labs(x = "Predicción", y = "Real") + coord_fixed(ratio=1) +
  theme_minimal()
```

```{r}
residuals <- augment(bagging_fit, new_data=datos_train) %>%
  mutate(residuals = .pred - edad_phijo) %>%
  select(residuals, .pred, edad_phijo)

residuals %>% ggplot(aes(x = .pred, y = residuals)) +
  geom_point() + geom_hline(yintercept = 0, color = 'red') +
  labs(x = "Predicción", y = "Residuos") +
  theme_minimal()
```

# Random Forest

```{r}
rf_spec <- rand_forest(mtry =.cols(), min_n=tune(),  trees=tune()) %>%
  set_engine('ranger', importance = "permutation", num.threads=6) %>%
  set_mode('regression')

rf_workflow <- workflow() %>%
  add_model(rf_spec) %>%
  add_recipe(datos_recipe)
```

```{r}
load('datos/rf_tune.RData')
```

```{r}
rf_spec <- rand_forest(mtry =5, min_n=130,  trees=2000) %>%
  set_engine('ranger', importance = "permutation", num.threads=6) %>%
  set_mode('regression')

rf_workflow <- workflow() %>%
  add_model(rf_spec) %>%
  add_recipe(datos_recipe)

rf_fit <- fit(rf_workflow, data = datos_train)
```

```{r}
vip(rf_fit) + theme_minimal()
```

```{r}
augment(rf_fit, new_data = datos_test) %>%
  ggplot(aes(x = .pred, y = edad_phijo)) +
  geom_point() +
  geom_abline(color='red') +
  labs(x = "Predicción", y = "Real") + coord_fixed(ratio=1) +
  theme_minimal()
```

```{r}
residuals <- augment(rf_fit, new_data=datos_train) %>%
  mutate(residuals = .pred - edad_phijo) %>%
  select(residuals, .pred, edad_phijo)

residuals %>% ggplot(aes(x = .pred, y = residuals)) +
  geom_point() + geom_hline(yintercept = 0, color = 'red') +
  labs(x = "Predicción", y = "Residuos") +
  theme_minimal()
```


# CART

```{r}
cart_spec <- decision_tree(cost_complexity = tune(),
                           min_n = tune(),
                           tree_depth = tune()) %>%
  set_engine('rpart') %>%
  set_mode('regression')

cart_workflow <- workflow() %>%
  add_model(cart_spec) %>%
  add_recipe(datos_recipe)

cart_grid <- grid_regular(cost_complexity(range = c(0.001, 0.2), trans=NULL),
                          min_n(range = c(10, 500)),
                          tree_depth(range = c(1, 20)),levels=5)

cart_cv <- vfold_cv(datos_train, v = 10)

cart_tune <- tune_grid(cart_workflow, resamples = cart_cv, grid = cart_grid)
```
```{r}
cart_tune
```


```{r}
best_cart <- cart_tune %>% select_best(metric='rmse')
```

```{r}
cart <- finalize_workflow(cart_workflow ,best_cart)

cart_fit <- fit(cart, data = datos_train)
```



```{r}
vip(cart_fit) + theme_minimal()
```


```{r}
augment(cart_fit, new_data = datos_test) %>%
  ggplot(aes(x = .pred, y = edad_phijo)) +
  geom_point() +
  geom_abline(color='red') +
  labs(x = "Predicción", y = "Real") + coord_fixed(ratio=1) +
  theme_minimal()
```













