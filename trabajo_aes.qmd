---
title: "Modelado de Variables Demográficas Mediante Algoritmos de Aprendizaje Supervisado"
format: pdf
lang: es
---

```{r setup, include=F, message=F, warning=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(survey)
library(srvyr)
library(ggstats)
library(kableExtra)
library(tidymodels)
library(vip)
library(DALEX)
library(DALEXtra)
```

\vspace{-6em}

# Introducción 

Cuando se trabaja con modelos de micro-simulación en demografía, como el modelado de las tasas específicas de fecundidad por edad (ASFR), uno de los factores usualmente considerados es la edad en que las mujeres comienzan a estar en riesgo de concebir. En este contexto, modelar la edad en que una cohorte de mujeres experimenta su primer nacimiento o inicia su vida sexual puede ser de gran utilidad en este tipo de simulaciones.

En este trabajo se propone el uso de modelos de aprendizaje supervisado para evaluar su desempeño en dos objetivos: por un lado, predecir la edad al primer hijo de las mujeres, y por otro, clasificar si una mujer comienza su vida sexual antes o después de una cierta edad. En ambos casos, se emplearán variables socioeconómicas y comportamentales de las mujeres como predictores. Se priorizará el uso de modelos basados en árboles de decisión, como Bagging, Random Forest y XGBoost.

Los datos utilizados para este propósito provienen de las encuestas DHS, realizadas principalmente en países en vías de desarrollo. En este caso particular, se analizarán las encuestas de las rondas VI y VII, correspondientes a distintos países y realizadas entre los años 2010 y 2020.

# Análisis exploratorio

## Fuente de los datos

Como se mencionó en la introducción, los datos provienen de las encuestas DHS[^1], el Programa de Encuestas Demográficas y de Salud (DHS) es responsable de recopilar y difundir datos precisos y representativos a nivel nacional sobre salud y población en países en desarrollo. 

La idea detrás es ayudar a los distintos países sobre todo del continente africano a dar asistencia técnica para la implementación de encuestas demográficas y de salud, donde se recolecta información sobre la fecundidad, planificación familiar, salud maternal e infantil y otros temas de salud como la malaria o el VIH que son de interés en gran parte de los países que contempla la encuesta.

[^1]: https://dhsprogram.com/data/available-datasets.cfm.

## Selección y descripción de los datos

Como primer paso, debido a la magnitud de la encuesta, que abarca un gran número de países y años, se optó por seleccionar un grupo de países representativos de distintas regiones. El objetivo fue capturar la heterogeneidad en las variables de interés desde diversos contextos económicos y culturales. Asimismo, se procuró que las encuestas seleccionadas correspondieran a un período de tiempo similar (en este caso, la década de 2010 a 2020) y que las variables, tanto de interés como explicativas, estuvieran disponibles en todas las encuestas incluidas. Como resultado de este proceso, se eligieron los siguientes países:

- América Latina y el Caribe: Perú, Guatemala y República Dominicana.
- Europa del este: Albania y Armenia.
- Norte y Sur de África: Etiopía y Sudáfrica.

En este caso, se dispone de un total de aproximadamente 105,000 observaciones correspondientes a mujeres de entre 15 y 64 años. Estas observaciones incluyen variables relacionadas con aspectos económicos, sociales y de salud reproductiva. Una complicación presente en los datos es que las disponibilidad de las distintas variables pueden variar de un país al otro y el proceso de descarga si se seleccionan demasiadas variables puede ser muy lento. Por esta razón se realizó un filtrado previo de las variables a utilizar. Como resultado, se trabaja principalmente con 30 variables que están disponibles para todos los países seleccionados y que, a priori, se consideran posiblemente relevantes para el análisis. 

```{r preprocesado}
datos_dhs <- read.csv('datos/dhs_6_7.csv') %>%
mutate(v000 = as.factor(case_when(
  v000 == 'AL7' ~ 'Albania',
  v000 == 'AM7' ~ 'Armenia',
  v000 == 'ET7' ~ 'Etiopia',
  v000 == 'GU6' ~ 'Guatemala',
  v000 == 'PE6' ~ 'Perú', 
  v000 == 'DR6' ~ 'República Dominicana', 
  v000 == 'ZA7' ~ 'Sudáfrica')), # País
  # Ponderador
  v005 = as.numeric(v005)/1e6, 
  # Año
  v007 = as.numeric(v007), 
  # Edad
  v012 = as.numeric(v012), 
  # PSU 
  v021 = as.factor(v021),
  # Estrato
  v022 = as.factor(paste0(SurveyId,'_',v022)),
  # Área Urbana/Rural
  v025 = as.factor(ifelse(v025==1,'Urbano','Rural')), 
  # Hogar Electricidad
  v119 = as.factor(case_when(v119==1~'Si', v119==0~'No')),
  # Hogar Televisión
  v121 = as.factor(case_when(v121==1~'Si', v121==0~'No')),
  # Años de Educación
  v133 = as.numeric(case_when(v133 %in% 97:99~NA, T~v133)),
  # Número de personas en el hogar
  v136 = as.numeric(v136),
  # Frecuencia de lectura
  v157 = as.factor(case_when(v157==0~'Nunca',v157%in%c(1,2)~ 'Frecuente',v157==3~'Todos los dias')),
  # Frecuencia de escuchar radio
  v158 = as.factor(case_when(v158==0~'Nunca',v158%in%c(1,2)~ 'Frecuente',v158==3~'Todos los dias')),
  # Frecuencia de ver noticias
  v159 = as.factor(case_when(v159==0~'Nunca',v159%in%c(1,2)~ 'Frecuente',v159==3~'Todos los dias')),
  # Categoría Riqueza
  v190 = as.factor(case_when(v190==1~'Más Pobre', v190==2~'Pobre', v190==3~'Medio', v190==4~'Rico', v190==5~'Más Rico')),
  # Indice de riqueza
  v191 = as.numeric(v191)/1e5,
  # Edad al primer hijo
  v212 = as.numeric(v212),
  # Conocimiento de métodos anticonceptivos
  v301 = as.factor(case_when(v301==0~'Ninguno', v301==1~'Folklórico', v301==2~'Tradicional', v301==3~'Moderno')),
  # Intención de uso de métodos anticonceptivos
  v364 = as.factor(case_when(v364%in%1:2~'Usando Metodo',
  v364%in%3:4~'No Usando Metodo',v364==5~'Nunca Tiene Relaciones')),
  # Cantidad de uniones
  v503 = as.factor(case_when(v501%in%c(0,2)~'No casada',v503==1~'Una', v503==2~'Más de Una')),
  # Edad al primer acto sexual
  v531 = as.numeric(case_when(v531 %in% 96:99 ~ NA, T~v531)),
  # Relaciones sexuales recientes
  v536 = as.factor(case_when(v536==0~'Nunca',v536==1~'Activa',
                             v536%in%2:3~'Inactiva')),
  # Numero ideal de hijos
  v613 = as.numeric(case_when(v613 %in% 50:99 ~ NA, T~v613)),
  # Años de educación de la pareja
  v715 = as.numeric(case_when(v715%in%97:99~NA, T~v715)),
  # Ocupación de la mujer
  v717 = as.factor(case_when(v717==0~'No Trabaja', v714==0~'No Trabaja', v717==1~'Profesional/Tecnico',v717%in%4:5~'Agricultura',v717%in%c(3,7)~'Servicios/Ventas',v717==6~'Domestico',v717%in%8:9~'Manual')),
  # Numero de parejas sexuales
  v836 = as.numeric(case_when(v836 %in% 96:99 ~ NA, T~v836))) %>% select(-SurveyId,-v501,-v714) %>% mutate(v190=factor(v190,levels=c('Más Pobre','Pobre','Medio','Rico','Más Rico'),ordered=T),v503=factor(v503,levels=c('No casada','Una','Más de Una'),ordered=T)) 

cod_variables <- names(datos_dhs)

name_variables <-c('id','pais','ponderador','anio','edad','psu','estrato','zona','hogar_elect','hogar_tv','anio_educ','n_fam_hogar','leer','radio','noticias','cat_riqueza','indice_riqueza','edad_phijo','con_antic','uso_antic','cant_uniones','edad_psexo','rec_sexo','nideal_hijos','anio_educ_par','ocupacion','n_parejas')

desc_variables <- c(
  'Identificador de la mujer encuestada',
  'País donde se realizó la encuesta',
  'Peso de la mujer en la encuesta, número entero de 8 dígitos, donde 6 dígitos corresponden a decimales',
  'Año en que se realizó la encuesta',
  'Edad de la mujer encuestada',
  'Unidad primaria de muestreo',
  'Estrato del que se obtuvo la observación',
  'Indica si la mujer es de un área urbana o rural',
  'Indica si el hogar tiene acceso a electricidad',
  'Indica si el hogar dispone de una televisión',
  'Total años de educación de la mujer, se calcula a partir del nivel máximo de educación alcanzado, es un valor comparable entre países.',
  'Total de personas que viven en el hogar',
  'Frecuencia con que la mujer lee un periódico, revista o libro',
  'Frecuencia con que la mujer escucha la radio',
  'Frecuencia con que la mujer ve noticias',
  'Categoria de riqueza del hogar',
  'Índice de riqueza del hogar estandarizado, se calcula a partir de distintas medidas como materiales de construcción de la casa y servicios disponibles, 5 dígitos corresponden a decimales.',
  'Edad de la mujer al primer hijo',
  'Conocimiento de algún método anticonceptivo, donde se distingue entre modernos (ej: Condon, pastillas, parches, etc.), tradicionales (ej: Coito interrumpido, calendario, etc.) y folklóricos (ej: Amuletos, rituales, etc.)',
  'Intención de uso de métodos anticonceptivos',
  'Cantidad de uniones que ha tenido la mujer',
  'Edad de la mujer al primer acto sexual',
  'Relaciones sexuales recientes de la mujer',
  'Número ideal de hijos',
  'Total años de educación de la pareja de la mujer',
  'Ocupación de la mujer',
  'Cantidad de parejas sexuales que ha tenido la mujer'
)

tipo_variables <- c(
  'Categórica',#id
  'Categórica',#pais
  'Numérica',#ponderador
  'Numérica Discreta',#anio
  'Numérica Discreta',#edad
  'Numérica Discreta',#psu
  'Categórica',#estrato
  'Categórica', #zona
  'Categórica', #hogar_elect
  'Categórica', #hogar_tv
  'Numérica Discreta', #anio_educ
  'Numérica Discreta', #n_fam_hogar
  'Categórica', #leer
  'Categórica', #radio
  'Categórica', #noticias
  'Categórica', #cat_riqueza
  'Numérica', #indice_riqueza
  'Numérica Discreta', #edad_phijo
  'Categórica', #con_antic
  'Categórica', #uso_antic
  'Categórica', #cant_uniones
  'Numérica Discreta', #edad_psexo
  'Categórica', #rec_sexo
  'Numérica Discreta', #nideal_hijos
  'Numérica Discreta' , #anio_educ_par
  'Categórica', #ocupacion
  'Numérica Discreta' #n_parejas
)

rec_variables <- c(paste0(nrow(datos_dhs),' Mujeres'), 
                   paste0(length(levels(datos_dhs$v000)),' Paises'),
                   ' ',
                   paste0(min(datos_dhs$v007),'-',max(datos_dhs$v007)),
                   paste0(min(datos_dhs$v012),'-',max(datos_dhs$v012)),
                   ' ',
                   ' ',
                   '1:Urbano, 2:Rural',
                   '0:No, 1:Si',
                   '0:No, 1:Si',
                   paste0(min(datos_dhs$v133,na.rm = T),'-', max(datos_dhs$v133, na.rm = T)),       paste0(min(datos_dhs$v136),'-',max(datos_dhs$v136)),
                   '0:Nada, 1:Ocasional, 2:Todos los días',
                   '0:Nada, 1:Ocasional, 2:Todos los días',
                   '0:Nada, 1:Ocasional, 2:Todos los días',
                   '1:Más Pobre, 2:Pobre, 3:Medio, 4:Rico, 5:Más Rico',                             paste0(min(datos_dhs$v191,na.rm = T), '-',max(datos_dhs$v191, na.rm = T)),       paste0(min(datos_dhs$v212,na.rm = T), '-', max(datos_dhs$v212, na.rm = T)),       '0: Ninguno, 1:Folklórico, 2:Tradicional, 3:Moderno',
                   '1:Usando Método, 2:No Usando Método, 3:Nunca Tiene Relaciones',
                   '0: No casada, 1: Una unión, 2: Más de una unión',
                   paste0(min(datos_dhs$v531,na.rm = T), '-',max(datos_dhs$v531, na.rm = T)),       '0: Nunca, 1: Activa, 2: No activa',
                   paste0(min(datos_dhs$v613,na.rm = T), '-',max(datos_dhs$v613, na.rm = T)),       paste0(min(datos_dhs$v715,na.rm = T), '-',max(datos_dhs$v715, na.rm = T)),
                   '0: No Trabaja, 1: Profesional/Técnico, 2: Agricultura, 3: Servicios/Ventas, 4: Doméstico, 5: Manual',
                   paste0(min(datos_dhs$v836,na.rm = T),'-',max(datos_dhs$v836,na.rm = T)))
                   
                   
tabla_variables <- data.frame(cod_variables, name_variables,desc_variables,tipo_variables,rec_variables)

names(datos_dhs) <- name_variables 
```

```{r}
kable(tabla_variables, caption = 'Descripción de las variables disponibles en el trabajo', col.names = c('Codigo DHS','Nombre','Descripción','Tipo','Recorrido'), align = 'ccllc', booktabs = TRUE) %>% 
  kable_styling(latex_options = "striped", font_size = 7, position = "center") %>% column_spec(3, width = '25em') %>%
  column_spec(5, width = '10em') %>% column_spec(c(1,2), width = '5em')
```

Antes de realizar el análisis exploratorio, se procede a limpiar los datos. Tomándose la precaución en cada variable de considerar las codificaciones de no respuesta y dato faltante, como el valor 99, que puede afectar la interpretación sobre todo en variables numéricas.

Se debe tener en cuenta que los datos provienen de una muestra compleja, debido a que éstas encuestas utilizan un diseño muestral estratificado y por conglomerados, lo que implica que las observaciones no son independientes. Por lo tanto se requiere del uso de pesos muestrales para hacer inferencias correctas, pero para el propósito de este trabajo, se optó por no incorporar explícitamente el diseño muestral en los modelos aunque si se ha tenido en cuenta la importancia de los pesos muestrales en el análisis exploratorio, lo cual permite una mejor comprensión de la estructura y distribución de los datos. Para esto último se utilizó la librería 'srvyr', la cuál nos permite trabajar de una manera correcta con la encuesta, nos deja incorporar el diseño muestral utilizado a nuestros datos, pasando como argumentos la unidad primaria de muestreo, el estrato del que se obtuvo la observación y el peso de la mujer en la encuesta.

[HABLAR UN POCO DEL DISEÑO MUESTRAL Y QUE SE CONTEMPLA EN EL ANALISIS EXPLORATORIO Y SE OPTO POR NO CONSIDERARLO EN LOS MODELOS] LISTO!

## Edad al primer hijo

[HAY QUE ACTUALIZAR EL TEXTO Y LOS GRAFICOS A LOS ULTIMOS DATOS UTILIZADOS, HACER GRAFICOS SOLO DE LAS VARIABLES QUE SE VEAN MAS IMPORTANTES EN EL RF] LISTO!

```{r muestra_phijo}
muestra_phijo <- datos_dhs %>% filter(edad_phijo >= 11) %>% na.omit() %>%
              as_survey_design(ids=psu,strata=estrato, weights=ponderador, nest=TRUE)
```

La edad en que las mujeres comienzan a tener hijos está influenciada por una serie de factores en los que se encuentran comportamientos sociales como también por aspectos económicos y culturales. En la bibliografía suelen mencionarse algunos factores que están fuertemente vinculados a los procesos de fecundidad, como la mayor participación en el mercado laboral, el acceso a la educación de las mujeres, la planificación familiar y el uso de métodos anticonceptivos.

En la @fig-phijo_xpais se puede observar como, dependiendo de que país sea la mujer encuestada, varía la edad que tenían al momento en que nació su primer hijo, algo esperable viniendo de paises con contextos muy distintos. En países como Etiopía, Guatemala o Dominicana, hay una gran parte de las mujeres encuestadas que tiene su primer hijo con veinte años o menos, mientras que en países del Este de Europa algo más desarrollados como Armenia o Albania, la edad al primer hijo tiende a ser mayor con una media por encima de los 20 años, patrón que usualmente se observa mientras más desarrollo más se atrasan todos los procesos relacionados con la fecundidad. Más allá de las diferencias, existe una gran concentración de mujeres que tienen su primer hijo entre los 18 y 23 años en todos los países.

```{r phijo_xpais}
#| label: fig-phijo_xpais
#| fig-cap: "Gráfico violín, distribución de la edad al primer hijo por país, donde el punto indica la edad media."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

mean_ephijo <- muestra_phijo %>% 
              group_by(pais) %>%
              summarise(edad_phijo = survey_mean(edad_phijo)) %>%
              mutate(pais=forcats::fct_reorder(pais, edad_phijo))
  
muestra_phijo %>% mutate(pais = factor(pais,levels=levels(mean_ephijo$pais))) %>%
ggsurvey(aes(x = edad_phijo, y = pais, fill=pais))  + geom_violin() +
  theme_minimal() + labs(x = 'Edad al primer hijo', y = 'País') + theme(legend.position = 'none') + scale_fill_viridis_d() 
```

```{r}
kable(mean_ephijo %>% mutate(across(c('edad_phijo', 'edad_phijo_se'), ~ round(., 2))) %>% arrange(edad_phijo), caption = 'Media y Desvio Estimados de la Edad al Primer Hijo por país', col.names = c('País','Media edad al primer hijo','Desvio'), align = 'lcc', booktabs = TRUE) %>% 
  kable_styling(latex_options = "striped", font_size = 9, position = "center") %>% column_spec(1, width = '20em') %>% column_spec(c(2,3), width = '5em')
```

Uno de los factores más importantes en el proceso del desplazamiento de la fecundidad a edades más avanzadas es el logro educativo de las mujeres. Esto es algo que en los datos utilizados en este trabajo debería poder ser captado. En la @fig-edu_att se observa la distribución de la edad al primer hijo donde cada línea corresponde a la cantidad de años de educación que tuvo la madre. En este caso, se puede observar claramente un corrimiento hacia la derecha de las modas de la distribución a medida que la mujer tiene más años de educación. Esto indica que mientras más estudios tienen las mujeres, más aplazan el momento de tener su primer hijo. Con lo cual en un principio esta variable debería ser útil para predecir la variable de interés.

```{r edu_att}
#| label: fig-edu_att
#| fig-cap: "Gráfico Densidad, distribución de la edad al primer hijo por Años de Educación de la Madre."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

muestra_phijo %>% filter(anio_educ<22) %>%
  ggsurvey(aes(x = edad_phijo, color = anio_educ, group=anio_educ)) + geom_density(linewidth=0.8) +
  labs(x = "Edad al Primer Hijo",
       y = "Frecuencia") +
  theme_minimal() + scale_color_viridis_c(name = "Años de Educación")
```

Este patrón es repetido por todos los países, aunque su efecto es más marcado en algunos paises, se observa la @fig-edu_att_xpais donde se tiene la distribución de la edad al primer hijo por país y si la madre presenta mas de 15 años de educación, este número surge del término de la educación secundaria, aunque puede variar según el país, 15 años de estudio es en general el momento en que se termina el nivel secundario. En todos los países, las mujeres con más años de educación tienden a tener su primer hijo a una edad más avanzada, aunque en países como Albania, este efecto parece bastante menos notorio.

```{r edu_att_xpais}
#| label: fig-edu_att_xpais
#| fig-cap: "Gráfico Caja, distribución de la edad al primer hijo por país y si la mujer tiene más de 15 años de educación."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

muestra_phijo %>% mutate(anio_edu_15=as.factor(ifelse(anio_educ>=15,1,0))) %>%
 ggsurvey(aes(x = pais, y=	edad_phijo, fill=anio_edu_15)) + 
  geom_boxplot(color = "grey") + theme_minimal()+ scale_fill_viridis_d(name='Años de educación', labels = c('Menor a 15 años', 'Mayor o igual a 15 años')) + labs(x = 'País', y = 'Edad al Primer Hijo') + theme(legend.position = 'top',axis.text.x = element_text(angle = 45, hjust = 1))
```

En la @fig-riqueza_xpais podemos observar la distrbución de la edad al primer hijo para los ditintos niveles de riqueza de los hogares, para algunos países, en general en todos los países observamos como se atrasa la edad a medida que el hogar es más rico, sobre todo en Albania, Perú y Sudáfrica. En otros como Dominicana o Armenia vemos que los niveles de riqueza están más concentrados en algún valor, salvo por el nivel más rico que ahí si se muestra un desplazamiento, no muy grande, pero un desplazamiento en fin, hacia edades un poco mayores. Por lo tanto se podría decir que en este caso la riqueza del hogar es una variable importante en este estudio.

[MUESTRA QUE LA RIQUEZA DEL HOGAR ES UNA VARIABLE IMPORTANTE COMO SE ATRASA A MEDIDA QUE EL HOGAR ES MAS RICO SOBRE TODO PARA ALGUNOS PAISES] LISTO!

```{r riqueza_xpais}
#| label: fig-riqueza_xpais
#| fig-cap: "Gráfico Densidad, distribución de la edad al primer hijo por riqueza del hogar para algunos paises."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

muestra_phijo %>% filter(pais%in%c('Armenia','Albania','Guatemala','Perú','Sudáfrica','República Dominicana')) %>%
  ggsurvey(aes(x = edad_phijo, color = cat_riqueza, group=cat_riqueza)) + geom_density(linewidth=0.5,alpha=.4) + facet_wrap(~pais) +
  labs(x = "Edad al Primer Hijo",
       y = "Frecuencia") +
  theme_minimal() + scale_color_viridis_d(name = "Riqueza del Hogar") + theme(legend.position='top')
```

Otro aspecto interesante en este tipo de estudio que se suele ver, es la cantidades de uniones y parejas sexuales que tienen las mujeres, por lo que se presenta la @fig-comp_parejas, donde observamos la ditrbución de la edad al primer hijo según estas variables. Vemos que las mujeres con más uniones tienden a tener hijos más jóvenes cuando tienen más de una pareja sexual, y además observamos esta tendencia en las mujeres con más parejas sexuales que no están casadas. También podemos observar que en las mujeres con una sola unión la edad al primer hijo se encuentra concentrada en los 20 años. 

[HABLAR QUE LAS MUJERES CON MAS UNIONES TIENDEN A TENER HIJOS MAS JOVENES Y QUE MAS PAREJAS SEXUALES INDICA UNA LEVE TENDENCIA A TENER HIJOS MAS JOVENES PARA MUJERES SIN CASAR O CON MAS DE UNA UNION, MENCIONAR QUE LAS MUJERES CON UNA SOLA UNION TIENDEN A ESTAR CONCENTRADAS EN 20 AÑOS ] LISTO!
```{r comp_parejas}
#| label: fig-comp_parejas
#| fig-cap: "Gráfico Caja, distribución de la edad al primer hijo por cantidad de uniones y cantidad de parejas sexuales."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

muestra_phijo %>% mutate(n_parejas=as.factor(case_when(n_parejas == 1 ~ '1', n_parejas == 2 ~ '2', n_parejas == 3 ~ '3', 
n_parejas >= 4 ~ '4 o más'))) %>%
 ggsurvey(aes(y = edad_phijo, x= n_parejas,fill=cant_uniones))  +  geom_boxplot(color = "grey") +
  labs(x = "Cantidad de parejas sexuales",
       y = "Edad al Primer Hijo") +
  theme_minimal() + scale_fill_viridis_d(name="Cantidad de uniones")
```

Otro aspecto que podría afectar en la edad al primer hijo podría estar relacionado con el acceso a distintos objetos materiales, como por ejemplo la televisión. En la @fig-hogar_tv vemos esta distrbución de la edad de las mujeres al primer hijo para esta variable por país, la cual nos muestra que en todos estos países la edad media al primer hijo se encuentra un poco por encima cuando los hogares tienen al menos una televisión. Ésta diferencia es muy marcada en países como Etipía y Albania, pero no está tan clara en países como Armenia y Sudáfrica. Cabe destacar además, que para Armenia y Albania existen muy pocas observaciones en donde los hogares no tuvieran una televisión, mientras que en Etipía hay 3 veces más hogares que no disponen de una televisión que los que si.

```{r hogar_tv}
#| label: fig-hogar_tv
#| fig-cap: "Gráfico Caja, distribución de la edad al primer hijo por si el hogar dispone de una televisión o no por país."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

muestra_phijo %>% 
 ggsurvey(aes(y = edad_phijo, x= pais, fill = hogar_tv))  + 
  geom_boxplot(color = "grey") + 
  theme_minimal() + 
  scale_fill_viridis_d(name='Dispone de una televisón en el hogar',
                       labels = c('No', 'Si')) + 
  labs(x = 'País', y = 'Edad al Primer Hijo') + 
  theme(legend.position = 'top',axis.text.x = element_text(angle = 45, hjust = 1))
```

### Selección de covariables relevantes

En este paso del estudio, lo que se realizó fue un Random Forest para determinar la importancia de las variables, seleccionando las más relevantes. Lo primero que se hizo fue sacar algunas variables relacionadas al diseño muestral, además de las variables que indican la edad de las mujeres y la edad al momento de la primera relación sexual ya que no se considera que tenga sentido para la utilidad del modelo. Luego dividimos los datos en entrenamiento y testeo, teniendo en cuenta además los países mediante el argumento strata, obteniendo entonces 39,122 datos de entrenamiento y 6,907 datos para testeo.

[HABLAR DE QUE SE REALIZA UN RF PARA DETERMINAR IMPORTANCIA DE VARIABLES, SELECCIONANDO LAS MAS RELEVANTES] LISTO!

[CAPAZ MENCIONAR QUE LO DE QUE LA EDAD A LA PRIMERA RELACIÓN SEXUAL NO SE CONSIDERA YA QUE NO TIENE DEMASIADO SENTIDO PARA LA UTILIDAD DEL MODELO] LISTO!

[MENCIONAR LA CANTIDAD DE DATOS UTILIZADOS, LA CANTIDAD DE DATOS PARA ENTRENAR Y QUE SE DIVIDEN TENIENDO ENCUENTA LOS PAISES (STRATA=PAIS)] LISTO!

```{r split_phijo}
datos_phijo <- datos_dhs %>% select(-id,-psu,-estrato,-anio,-ponderador,-edad,-edad_psexo) %>%
  filter(edad_phijo >= 11) %>% na.omit() %>%
  initial_split(strata=pais,prop=0.85)

train_phijo <- training(datos_phijo)
test_phijo <- testing(datos_phijo)
```

En la búsuqeda de un modelo eficiente con hiperparámetros óptimos, mediante la técnica de validación cruzada utilizando 'k-folds cross validation' con 10 folds, se busca el número mínimo de observaciones por nodo *(min_n)* y el número de predictores que se seleccionarán aleatoriamente en cada división *(mtry)*. Cabe mencionar además que la grilla no se afino demasiado y que se usan 1000 árboles.

[MENCIONAR QUE SE TUNEA (MTRY Y MIN_N) EL RF PARA OBTENER LA IMPORTANCIA CON CV PERO SIN AFINAR MUCHO LA GRILLA Y QUE SE USAN 1000 ARBOLES] LISTO!

```{r tune vip_phijo, eval=F}
vip_phijo_spec <- rand_forest(mtry=tune(), min_n=tune(),  trees=1000) %>%
  set_engine('ranger', num.threads=12) %>%
  set_mode('regression')

vip_phijo_workflow <- workflow() %>%
  add_model(vip_phijo_spec) %>%
  add_recipe(recipe(edad_phijo ~ ., data = train_phijo))

vip_phijo_cv <- vfold_cv(train_phijo, v = 10)

vip_phijo_tune <- tune_grid(vip_phijo_workflow, resamples = vip_phijo_cv, grid = 30)

vip_phijo_best <- vip_phijo_tune %>% select_best(metric='rmse')

# Actualizamos el modelo para que calcule la importancia de las variables
vip_phijo_fit <- vip_phijo_workflow %>% update_model(
  rand_forest(mtry =tune(), min_n=tune(),  trees=1000) %>%
  set_engine('ranger',importance='permutation',num.threads=12) %>% set_mode('regression')
  ) %>%
  finalize_workflow(vip_phijo_best) %>% fit(data = train_phijo)
```

```{r}
# Carga Modelo RF importancia edad al primer hijo
load('datos/imp_phijo.RData')

imp_phijo <- vip(vip_phijo_fit,num_features=19)
```

En la @fig-vip_phijo vemos en forma de barras la importancia de las variables en este modelo, ordenadas de mayor a menor importancia. Como mencionamos al comienzo del estudio, lo que se busca son las variables con mayor importancia para continuar con el estudio, por lo que elegimos las 10 variables más relevantes para seguir adelante. Por lo tanto de ahora en adelante se trabajará con las variables: anio_educ, pais, indice_riqueza, cant_uniones, anio_educ_par, hogar_tv, cat_riqueza, n_parejas, nideal_hijos y n_fam_hogar.

[HABLAR UN POCO DE LAS VARIABLES QUE QUEDAN, MENCIONAR QUE SE TOMAN LAS MAS IMPORTANTES (POR EJEMPLO 10)] LISTO!

```{r vip_phijo}
#| label: fig-vip_phijo
#| fig-cap: "Gráfico barras, importancia de las variables consideradas en el modelo de Random Forest mediante permutación para predecir la edad al primer hijo."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

imp_phijo + labs(x = 'Variable', y = 'Importancia') + theme_minimal()
```

```{r best_vars_phijo}
best_vars_phijo <- imp_phijo$data %>% slice_max(order_by = Importance, n=10) %>% pull(Variable)
```

## Primera relación sexual

Como mencionamos al comienzo, esta parte va a tratar sobre un problema de clasificación en el que se buscará clasificar si una mujer comienza su vida sexual antes o después de los 18 años. Como esta variable está muy relacionada con la edad de la mujer al momento de tener su primer hijo, las covariables más relevantes en general son las mismas.

[MENCIONAR QUE ES UNA VARIABLE MUY RELACIONADA A LA EDAD AL PRIEMR HIJO CON LO QUE LAS COVARIABLES MAS RELEVANTES EN GENERAL SON LAS MISMAS] LISTO!

```{r muestra_psexo}
muestra_psexo <- datos_dhs %>% filter(edad_psexo >= 9) %>% na.omit() %>%
   mutate(psexo_18 = ifelse(edad_psexo >= 18, 1, 0)) %>%
              as_survey_design(ids=psu,strata=estrato, weights=ponderador, nest=TRUE)
```

La edad a la que una mujer comienza su vida sexual puede variar según una combinación de factores personales, familiares y sociales. Las influencias más comunes incluyen el entorno cultural en el que crece, el acceso a la educación y la información sobre salud sexual, además de las expectativas sociales y familiares. Además, el contexto económico y la disponibilidad de recursos, como servicios de salud accesibles, también pueden tener un impacto.  

En la @fig-psexo_xpais vemos la proporción de mujeres que comenzaron a tener relaciones sexuales antes y después de los 18 años por país. Lo que más llama la atención es que en los países de Europa como Albania y Armenia casi cuatro quintos de las observaciones comienzan luego de los 18 años, mientras que en el resto de los países esto baja a cerca de un medio del total de observaciones, también mencionar que en Etiopía cerca del 70% del total de observaciones comienzan su vida sexual antes de ésta edad.

[COMENTAR EL ANALISIS EXPLORATORIO] LISTO!

```{r psexo_xpais}
#| label: fig-psexo_xpais
#| fig-cap: "Gráfico barras, Estimación de la proporción de mujeres que comienzan a tener relaciones sexuales antes de los 18 años por país."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

prop_psexo <- muestra_psexo %>%
              group_by(pais) %>%
              summarise(mayor_18 = survey_mean(psexo_18), menor_18 = 1-survey_mean(psexo_18)) %>% select(pais,mayor_18,menor_18)  %>% pivot_longer(cols = c("mayor_18","menor_18"), 
               names_to = "edad", 
               values_to = "proporcion")
  
prop_psexo %>%
ggplot(aes(x = pais, y = proporcion, fill=edad)) +
  geom_bar(stat = "identity", position = "fill") +
  theme_minimal() + labs(x = 'País', y = '') + scale_fill_viridis_d("Comienzo Relaciones\nSexuales",labels=c("Mayor o igual a 18 años", "Menor a 18 años")) + theme(legend.position = 'top',axis.text.x = element_text(angle = 45, hjust = 1))
```

Como en el caso de la edad al primer hijo, en la $fig-edu_att_cls se observa que a medida que los años de educación aumentan, también lo hace la edad a la que las mujeres comienzan su vida sexual. Este patrón es común en la literatura y está relacionado con una mayor conciencia sobre la salud sexual.

```{r edu_att_clas}
#| label: fig-edu_att_clas
#| fig-cap: "Gráfico Densidad, distribución de la edad al primer hijo por Años de Educación de la Madre."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

muestra_psexo %>% 
  ggsurvey(aes(x = as.factor(psexo_18), y = anio_educ,fill=as.factor(psexo_18))) + geom_boxplot() +
  labs(x = "",
       y = "Años de Educación de la Mujer") +
  theme_minimal() + scale_fill_viridis_d(name = "Comienzo Relaciones Sexuales",labels=c("Menor a 18 años","Mayor o igual a 18 años"))
```

[AÑADIR ALGUN GRAFICO EXPLORATORIO MAS]

### Selección de covariables relevantes

En este paso, también se utilizó un modelo de Random Forest para evaluar la importancia de las variables en la predicción de la variable psexo_18, que indica si la mujer comienza a tener relaciones sexuales después de los 18 años. Similar al análisis previo, primero se eliminaron algunas variables asociadas al diseño muestral, así como aquellas que no aportan a la interpretación del modelo, como la edad al primer hijo. Además, se filtraron los datos para incluir solo a mujeres con 9 años o más.

Los datos fueron divididos en conjuntos de entrenamiento y testeo, tomando en cuenta los países mediante el argumento strata para garantizar una distribución proporcional. El conjunto de entrenamiento se compuso de 41,945 observaciones, mientras que el de prueba incluyó 7,404.

```{r split_psexo}
datos_psexo <- datos_dhs %>% select(-id,-psu,-estrato,-anio,-ponderador,-edad,-edad_phijo) %>%
   filter(edad_psexo >= 9) %>% na.omit() %>%
   mutate(psexo_18 = as.factor(ifelse(edad_psexo >= 18, 1, 0))) %>%
  select(-edad_psexo) %>%
  initial_split(strata=pais,prop=0.85)

train_psexo <- training(datos_psexo)
test_psexo <- testing(datos_psexo)
```

Para optimizar el modelo, se empleó la técnica de validación cruzada con 10 folds devuelta, ajustando los hiperparámetros clave como el número mínimo de observaciones por nodo y el número de predictores aleatorios seleccionados en cada división. Al igual que lo realizado en el análisis anterior, se mantuvo una grilla de búsqueda sencilla, y se optó por usar 1000 árboles.

```{r tune vip_psexo, eval=F}
vip_psexo_spec <- rand_forest(mtry=tune(), min_n=tune(), trees=1000) %>%
  set_engine('ranger', num.threads=48) %>%
  set_mode('classification')

vip_psexo_workflow <- workflow() %>%
  add_model(vip_psexo_spec) %>%
  add_recipe(recipe(psexo_18 ~ ., data = train_psexo))

vip_psexo_cv <- vfold_cv(train_psexo, v = 10)

vip_psexo_tune <- tune_grid(vip_psexo_workflow, resamples = vip_psexo_cv, grid = 30)

vip_psexo_best <- vip_psexo_tune %>% select_best(metric='roc_auc')

# Actualizamos el modelo para que calcule la importancia de las variables
vip_psexo_fit <- vip_psexo_workflow %>% update_model(
  rand_forest(mtry =tune(), min_n=tune(),  trees=1000) %>%
    set_engine('ranger',importance='permutation',num.threads=48) %>% 
    set_mode('classification')
) %>%
  finalize_workflow(vip_psexo_best) %>% fit(data = train_psexo)
```

```{r}
# Carga Modelo RF importancia edad a la primera relacion sexual
load('datos/imp_psexo.RData')

imp_psexo <- vip(vip_psexo_fit,num_features=19)
```

En la @fig-vip_psexo se presenta un gráfico de barras que muestra la importancia de las variables utilizadas en el modelo, ordenadas de mayor a menor. A partir de esta evaluación, se seleccionaron las 10 variables más relevantes para continuar con el análisis. Estas variables son: anio_educ, pais, indice_riqueza, n_parejas, anio_educ_par, cant_uniones, hogar_tv, cat_riqueza, noticias y hogar_elect.

[HABLAR UN POCO DE LAS VARIABLES QUE QUEDAN, MENCIONAR QUE SE TOMAN LAS MAS IMPORTANTES] LISTO!

```{r vip_psexo}
#| label: fig-vip_psexo
#| fig-cap: "Gráfico barras, importancia de las variables consideradas en el modelo de Random Forest mediante permutación para predecir si comienza a tener relaciones luego de los 18 años."
#| fig-align: center
#| fig-height: 5
#| fig-width: 8

imp_psexo + labs(x = 'Variable', y = 'Importancia') + theme_minimal()
```

```{r best_vars_phijo}
best_vars_psexo <- imp_psexo$data %>% slice_max(order_by = Importance, n=10) %>% pull(Variable)
```

# Modelado de la edad al primer hijo

Una vez visualizados los datos y posibles relaciones en las variables se procede a armar los modelos. 

Para incorporar información sobre el contexto social y económico se toman en cuenta estas 5 variables, algunas de ellas hemos visualizado su efecto, siendo este relevante:

- País de procedencia de la mujer.
- Indice de riqueza del hogar.
- Si el hogar dispone de televisión.
- Si la mujer se encuentra en una área urbana o rural.
- Si la mujer trabaja en la actualidad.

Por lado del nivel educativo de la mujer se toman en cuenta las siguientes variables:

- Años de educación de la mujer.
- Si la mujer lee periódicos, revistas o libros.

Por último, se consideran las siguientes variables relacionadas con el comportamiento sexual de la mujer:

- Cantidad de parejas sexuales que ha tenido la mujer.
- Si la mujer conoce algún método anticonceptivo.

En esta primera aproximación al problema se opta por solamente tomar las observaciones que dispongan de todos los datos necesarios para el modelo, no realizándose imputaciones de datos faltantes o análisis de la no respuesta a la encuesta. 

En total se entrena al modelo con 80,359 observaciones de mujeres donde se utilizara un 85% de los datos para entrenar y el 15% restante para evaluar el modelo.

En este caso se trabaja integramente con 'tidymodels' framework que permite realizar la evaluación de los modelos de manera sencilla. Se opta por evaluar la eficiencia de modelos basados en árboles: Bagging, Random Forest y XGBoost, donde para cada uno se realiza su correspondiente tuneo de hiperparámetros.

```{r modelos_phijo, eval=F}
basic_recipe <- recipe(edad_phijo ~., data=train_phijo) %>%
                update_role(-all_of(c('edad_phijo',best_vars_phijo)), new_role = "exclude") 

xgb_recipe <- basic_recipe %>%
  step_dummy(all_nominal_predictors())

bagg_spec <- rand_forest(mtry=.cols(),min_n=tune(),trees=tune()) %>%
  set_engine('ranger', num.threads=48) %>%
  set_mode('regression')

bagg_grid <- expand.grid(trees=c(25,50,100,500,1000),
                         min_n=c(50,100,150,200,250,300,350,400,450,500,
                           1000,1500,2000,2500))

rf_spec <- rand_forest(mtry = tune(), min_n = tune(), trees= tune()) %>%
  set_engine("ranger", num.threads = 48) %>%
  set_mode("regression")

rf_grid <- expand.grid(mtry = c(2,4,6,8,10),
                       min_n = c(50, 100, 150, 200, 250, 300, 350, 400, 450, 500,1000,1500,2000,2500),
                       trees = c(25, 50, 100, 500, 1000))

xgb_spec <- boost_tree(tree_depth = tune(), learn_rate = tune(), min_n = tune(), trees=500) %>%
  set_engine("xgboost") %>%
  set_mode("regression")

xgb_grid <- expand.grid(tree_depth = c(2, 4, 6, 8, 10),
                        learn_rate = c(0.01, 0.025, 0.05, 0.1, 0.2),
                        min_n = c(50, 100, 200, 300, 400, 500, 1000, 2000))

phijo_wf <- workflow_set(preproc=list(basic_rec=basic_recipe,basic_rec=basic_recipe,xgb_rec=xgb_recipe),model=list(bagg=bagg_spec,rf=rf_spec,xgb=xgb_spec),cross=F)  %>%
  option_add(grid = bagg_grid, id = "basic_rec_bagg") %>%
  option_add(grid = rf_grid, id = "basic_rec_rf") %>%
  option_add(grid = xgb_grid, id = "xgb_rec_xgb")

phijo_cv <- vfold_cv(train_phijo, v = 10)

tune_phijo <- phijo_wf %>% workflow_map(resamples =phijo_cv)
```

## Búsqueda de Hiperparámetros 

## Comparación de modelos

## Evalación modelo final

## Interpretación e importancia de las variables

# Modelado de la edad a la primera relación sexual

## Búsqueda de Hiperparámetros 

## Comparación de modelos

## Evalación modelo final

## Interpretación e importancia de las variables

